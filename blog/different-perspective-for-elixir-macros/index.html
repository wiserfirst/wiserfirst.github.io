<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>A Different Perspective for Elixir Macros | Peaceful Revolution</title> <meta name="description" content="Some random thoughts about Elixir Macros"> <meta name="author" content="Qing Wu"> <meta property="article:author" content="Qing Wu"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_GB"> <meta property="og:site_name" content="Peaceful Revolution"> <meta property="og:title" content="A Different Perspective for Elixir Macros"> <meta property="og:url" content="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/"> <meta property="og:description" content="Some random thoughts about Elixir Macros"> <meta property="og:image" content="https://www.wiserfirst.com/assets/images/2022-03-21/australia_nature_1440_420.jpg"> <meta name="twitter:site" content="@wiserfirst"> <meta name="twitter:title" content="A Different Perspective for Elixir Macros"> <meta name="twitter:description" content="Some random thoughts about Elixir Macros"> <meta name="twitter:url" content="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.wiserfirst.com/assets/images/2022-03-21/australia_nature_1440_420.jpg"> <meta name="twitter:creator" content="@wiserfirst"> <meta property="article:published_time" content="2022-03-21T11:48:00+11:00"> <link rel="canonical" href="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Qing Wu",
      "url": "https://www.wiserfirst.com/"
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Peaceful Revolution Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript> </head> <body class="layout--single wide"> <nav class="skip-links"> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Peaceful Revolution </a> <ul class="visible-links"></ul> <button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <i class="fas fa-search"></i> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('/assets/images/2022-03-21/australia_nature_1440_420.jpg');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> A Different Perspective for Elixir Macros </h1> <p class="page__lead">Some random thoughts about Elixir Macros </p> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-calendar-alt" aria-hidden="true"></i> <time datetime="2022-03-21T11:48:00+11:00">March 21, 2022</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-clock" aria-hidden="true"></i> 4 minute read </span> </p> </div> <span class="page__hero-caption">Image by <a href="https://unsplash.com/@dylanshaw?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Dylan Shaw</a> from <a href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> </span> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/f9dbde9c6042a54fde3da7ef83ef4bd9" alt="Qing Wu" itemprop="image"> </a> </div> <div class="author__content"> <a href="/"><h3 class="author__name" itemprop="name">Qing Wu</h3></a> <div class="author__bio" itemprop="description"> <p>Developer ❤️ Functional Programming</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://www.wiserfirst.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:wiserfirst@gmail.com"> <meta itemprop="email" content="wiserfirst@gmail.com"/> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://twitter.com/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://github.com/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> </ul> </div> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="A Different Perspective for Elixir Macros"> <meta itemprop="description" content="Some random thoughts about Elixir Macros"> <meta itemprop="datePublished" content="2022-03-21T11:48:00+11:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p>In Elixir, macros are a way of metaprogramming, which is sometimes explained as something like “using code to write code”. While offering good intuition on what metaprogramming is about, it’s not very accurate, because it doesn’t actually write code.</p> <p>When trying to understand macros, I use the slightly different mental model: a macro is like a template with a name that can optionally have parameters; when the name is used, it’s substituted by the template with “values” of the arguments injected.</p> <p>Sorry if it didn’t make it better. I’ll try to explain what do I mean by that. But let’s first review how C macros work.</p> <h2 id="c-macos">C Macos</h2> <p>Before actually compiling a C program, the C compiler will use the C preprocessor to transform the program, which is also referred to as preprocessing. One of the things that happens in this preprocessing step is macro expansion.</p> <p>In GNU’s online documentation for <a href="https://gcc.gnu.org/onlinedocs/cpp/Macros.html">the C Preprocessor</a>, a macro is defined as following:</p> <blockquote> <p>A macro is a fragment of code which has been given a name. Whenever the name is used, it is replaced by the contents of the macro.</p> </blockquote> <p>You can define a macro like this:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DOUBLE(x) (2 * x)
</span></code></pre></div></div> <blockquote> <p>NOTE: by convention macro names in C use uppercase.</p> </blockquote> <p>And then use it as below:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DOUBLE</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div> <p>During preprocessing, the preprocessor will replace it with <code class="language-plaintext highlighter-rouge">(2 * x)</code>. The compiler would just see <code class="language-plaintext highlighter-rouge">(2 * x)</code> as if you wrote it in stead of <code class="language-plaintext highlighter-rouge">DOUBLE(5)</code> in the first place.</p> <p>So a macro in C allows us to define a fragment of code that can have parameters, and when it’s used the macro name would be replaced by the code fragment we defined with arguments interpolated.</p> <p>It’s worth noting that since this happens before compilation, the program is still just a piece of text, so both arguments interpolation and macro expansion are just literal text substitution.</p> <p>How does this relate to Elixir’s macros? Well macro expansion in Elixir is definitely not text substitution, but it’s still substitution, just happens at a higher level.</p> <h2 id="the-abstract-syntax-tree-ast">The Abstract Syntax Tree (AST)</h2> <p>Most programming languages have the Abstract Syntax Tree (AST), which is a tree structure the compiler builds from the source code before turning it into either machine code or byte code.</p> <p>In most languages, the AST is not exposed to us developers and we can get our code working without worrying about the AST or even knowing about it.</p> <p>In the case of Elixir, the compiler give us access to the AST. This comes with great power and allows us to do many things that aren’t possible in other languages, creating macros among them.</p> <p>You can get the AST for a piece of code by using <code class="language-plaintext highlighter-rouge">quote</code>, for example:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span>
<span class="o">...</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span>
<span class="o">...</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">end</span>
<span class="p">{</span><span class="ss">:+</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div></div> <p>This is probably the simplest form, but in general Elixir’s AST is represented as a three elements tuple. When the expression is more complex, its corresponding AST is usually deeply nested.</p> <p>In Elixir, the AST is also known as quoted expressions.</p> <p>For more details on working with quoted expressions, please refer to offical <a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html">Quote and unquote</a> guide.</p> <h2 id="macros-in-elixir">Macros in Elixir</h2> <p>One thing to remember about macros in Elixir is that they receive AST as arguments and return AST.</p> <p>You can define a macro with <code class="language-plaintext highlighter-rouge">defmacro</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyIf</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">action</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">case</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">x</span> <span class="ow">when</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="no">false</span><span class="p">,</span> <span class="no">nil</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="no">nil</span>
        <span class="n">_</span> <span class="o">-&gt;</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then you can use it by:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">require</span> <span class="no">MyIf</span>

<span class="no">MyIf</span><span class="o">.</span><span class="k">if</span> <span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>

<span class="c1"># or</span>

<span class="no">MyIf</span><span class="o">.</span><span class="k">if</span> <span class="no">false</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Will not print anything"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="mental-models-about-macros">Mental models about Macros</h2> <h3 id="tree-metaphor">Tree Metaphor</h3> <p>To understand how macros work in general, I often use the tree metaphor. The entire program is just a big tree containing data and expressions as nodes, some of which are macro usages. This is literally correct with Elixir, because the compiler do convert the program into a big abstract syntax tree in the form of a deeply nested three elements tuple.</p> <p>Defining a macro is like creating a template in AST or say a sub-tree. If there are arguments, they can be injected to the sub-tree with <code class="language-plaintext highlighter-rouge">unquote</code>.</p> <p>During macro expansion, the Elixir compiler will replace each macro usage node with the AST sub-tree returned by its macro definition with the arguments injected. Because macros can be used inside another macro, macro expansion will happen repeatedly until there are no more macros.</p> <p>If we compare Elixir macros with C macros, we can see that they both offer a way to substitute an expression with a template. The difference is that in C we define the template as text and replaced as text, whereas in Elixir, the template is defined as a piece of AST and the substitution happens at the AST level as well.</p> <h3 id="copy-paste-metaphor">Copy-Paste Metaphor</h3> <p>To figure out what a particular macro does, I usually think of it as copying what the macro definition has and pasting it where the macro is being used. For unquoted arguments, mentally replace them with the corresponding values passed in.</p> <p>When the macro is more complex, this might not work, but it should still set one on the right path in understanding the macro.</p> <h2 id="summary">Summary</h2> <p>Macros are hard and they can be daunting even for experienced developers.</p> <p>In this short post, I tried to offer a different perspective in understanding macros in Elixir.</p> <p>It would fantastic if this makes it slightly easier for someone to learn about macros.</p> <p>If you’d like to learn more about Elixir macros, check out <a href="https://twitter.com/sasajuric">Saša Jurić</a>’s great blog post series <a href="https://www.theerlangelist.com/article/macros_1">Understanding Elixir Macros</a> and <a href="https://twitter.com/chris_mccord">Chris Mccord</a>’s book <a href="https://pragprog.com/titles/cmelixir/metaprogramming-elixir/">Metaprogramming Elixir</a>.</p> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/elixir" class="page__taxonomy-item" rel="tag">elixir</a><span class="sep">, </span> <a href="/tags/macro" class="page__taxonomy-item" rel="tag">macro</a><span class="sep">, </span> <a href="/tags/tiny-tips" class="page__taxonomy-item" rel="tag">tiny-tips</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-03-21T11:48:00+11:00">March 21, 2022</time></p> </footer> <section class="page__share"> <h4 class="page__share-title">Share on</h4> <a href="https://twitter.com/intent/tweet?via=wiserfirst&text=A+Different+Perspective+for+Elixir+Macros%20https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fdifferent-perspective-for-elixir-macros%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fdifferent-perspective-for-elixir-macros%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fdifferent-perspective-for-elixir-macros%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/pi-hole-on-raspberry-pi/" class="pagination--pager" title="Setup Pi-hole on Raspberry Pi ">Previous</a> <a href="#" class="pagination--pager disabled">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Leave a comment</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You may also enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-10-18/pi_zero_1440_420.jpg" alt="Code with Elixir and Phoenix"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/pi-hole-on-raspberry-pi/" rel="permalink">Setup Pi-hole on Raspberry Pi </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-10-18T11:45:00+11:00">October 18, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 6 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Install in one place and protect your entire network </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-09-19/elixir_code_1440_420.jpg" alt="Code with Elixir and Phoenix"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/upgrade-to-phoenix-16/" rel="permalink">Journey of upgrading an app to Phoenix 1.6 </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-09-19T12:25:00+10:00">September 19, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 7 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Say goodbye to webpack and Node in your Phoenix applications </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-09-07/macbook_1440_400.jpg" alt="Macbook on desk"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/setup-macbook-for-developers/" rel="permalink">Setup New Mac for Software Development </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-09-07T11:35:00+10:00">September 7, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 4 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Step by step guide for setting up a new Mac computer </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-07-25/dice_1440_400.jpg" alt="Random array of dice"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/typescript-random-array-element/" rel="permalink">Get Random Array Element in Typescript </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-07-24T16:35:00+10:00">July 24, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 3 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Typescript Mini-patterns </p> </article> </div> </div> </div> </div> </div> <div class="search-content"> <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';"> <label class="sr-only" for="search"> Enter your search term... </label> <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..."/> </form> <div id="results" class="results"></div></div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li><strong>Follow:</strong></li> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">&copy; 2023 Qing Wu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-174550807-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> <script>var disqus_config=function(){this.page.url="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/",this.page.identifier="/blog/different-perspective-for-elixir-macros"};!function(){var e=document,t=e.createElement("script");t.src="https://wiserfirst.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </body> </html>