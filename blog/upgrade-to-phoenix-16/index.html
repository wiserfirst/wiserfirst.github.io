<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>Journey of upgrading an app to Phoenix 1.6 | Peaceful Revolution</title> <meta name="description" content="Say goodbye to webpack and Node in your Phoenix applications"> <meta name="author" content="Qing Wu"> <meta property="article:author" content="Qing Wu"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_GB"> <meta property="og:site_name" content="Peaceful Revolution"> <meta property="og:title" content="Journey of upgrading an app to Phoenix 1.6"> <meta property="og:url" content="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/"> <meta property="og:description" content="Say goodbye to webpack and Node in your Phoenix applications"> <meta property="og:image" content="https://www.wiserfirst.com/assets/images/2021-09-19/elixir_code_1440_420.jpg"> <meta name="twitter:site" content="@wiserfirst"> <meta name="twitter:title" content="Journey of upgrading an app to Phoenix 1.6"> <meta name="twitter:description" content="Say goodbye to webpack and Node in your Phoenix applications"> <meta name="twitter:url" content="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.wiserfirst.com/assets/images/2021-09-19/elixir_code_1440_420.jpg"> <meta name="twitter:creator" content="@wiserfirst"> <meta property="article:published_time" content="2021-09-19T12:25:00+10:00"> <meta property="article:modified_time" content="2021-09-28T12:05:00+10:00"> <link rel="canonical" href="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Qing Wu",
      "url": "https://www.wiserfirst.com/"
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Peaceful Revolution Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript> </head> <body class="layout--single wide"> <nav class="skip-links"> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Peaceful Revolution </a> <ul class="visible-links"></ul> <button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <i class="fas fa-search"></i> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('/assets/images/2021-09-19/elixir_code_1440_420.jpg');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> Journey of upgrading an app to Phoenix 1.6 </h1> <p class="page__lead">Say goodbye to webpack and Node in your Phoenix applications </p> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-09-19T12:25:00+10:00">September 19, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-clock" aria-hidden="true"></i> 7 minute read </span> </p> </div> <span class="page__hero-caption">Code with Elixir and Phoenix </span> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/f9dbde9c6042a54fde3da7ef83ef4bd9" alt="Qing Wu" itemprop="image"> </a> </div> <div class="author__content"> <a href="/"><h3 class="author__name" itemprop="name">Qing Wu</h3></a> <div class="author__bio" itemprop="description"> <p>Developer ❤️ Functional Programming</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://www.wiserfirst.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:wiserfirst@gmail.com"> <meta itemprop="email" content="wiserfirst@gmail.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://twitter.com/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://github.com/wiserfirst" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> </ul> </div> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="Journey of upgrading an app to Phoenix 1.6"> <meta itemprop="description" content="Say goodbye to webpack and Node in your Phoenix applications"> <meta itemprop="datePublished" content="2021-09-19T12:25:00+10:00"> <meta itemprop="dateModified" content="2021-09-28T12:05:00+10:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p>Phoenix 1.6 RC0 was released just over three weeks ago and I’m really excited about it. Because it provides the option to replace webpack with esbuild, so that we no longer need Node for asset building.</p> <p>True that it’s just the first release candidate, but we are still one step closer to the formal release.</p> <blockquote> <p><strong>Update (28 September 2021):</strong> <a href="https://github.com/phoenixframework/phoenix/releases/tag/v1.6.0">Phoenix 1.6.0</a> was released three days ago on 25 September, so now we do have our formal release</p> </blockquote> <p>Last week, I managed to upgrade my little side project <a href="https://github.com/wiserfirst/rubiks_cube_algs_trainer">Rubik’s Cube Algorithms Trainer</a> to Phoenix 1.6 and I’ll share my journey in this post. For the most part, I was following the <a href="https://gist.github.com/chrismccord/2ab350f154235ad4a4d0f4de6decba7b">Phoenix 1.5.x to 1.6 upgrade instructions</a> by <a href="https://twitter.com/chris_mccord">Chris McCord</a>.</p> <p>If you prefer watching a video than reading, I also did a talk about it at <a href="https://www.meetup.com/elixir-sydney/events/gztkjsyccmbtb/">Elixir Sydney September 2021 meetup</a> and the recording is on <a href="https://www.youtube.com/watch?v=NR_Jk3yUEqc">Youtube</a>.</p> <h2 id="update-dependencies-in-mixfile">Update dependencies in Mixfile</h2> <p>First we need to update the dependencies in the <code class="language-plaintext highlighter-rouge">mix.exs</code> file:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="s2">"~&gt; 1.6.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="s2">"~&gt; 3.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_view</span><span class="p">,</span> <span class="s2">"~&gt; 0.16.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_dashboard</span><span class="p">,</span> <span class="s2">"~&gt; 0.5"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:telemetry_metrics</span><span class="p">,</span> <span class="s2">"~&gt; 0.6"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:telemetry_poller</span><span class="p">,</span> <span class="s2">"~&gt; 0.5"</span><span class="p">},</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then run <code class="language-plaintext highlighter-rouge">mix deps.get</code> to install the new dependencies.</p> <p>Two thing to note here:</p> <ul> <li> <del>For <code class="language-plaintext highlighter-rouge">phoenix</code>, the <code class="language-plaintext highlighter-rouge">override: true</code> option is important, because Phoenix 1.6 is still in RC</del> (This is no longer the case, since Phoenix 1.6.0 has been released)</li> <li>If you want to use the new <code class="language-plaintext highlighter-rouge">HEEx</code> templates, add <code class="language-plaintext highlighter-rouge">phoenix_live_view</code> even if you don’t actually use live view</li> </ul> <h2 id="esbuild-for-javascript-and-css-bundling-optional">esbuild for Javascript and CSS bundling (optional)</h2> <p>Next step is to use esbuild for Javascript and CSS bundling. This is an optional step in upgrading to Phoenix 1.6, but it is what I’m all excited about, so it’s not optional for me <img class="emoji" title=":smirk:" alt=":smirk:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f60f.png" height="20" width="20"></p> <h3 id="phoenix-asset-pipeline-overview">Phoenix asset pipeline overview</h3> <p>Before jumping into replacing webpack with esbuild, it’s worth having a quick review of the existing Phoenix asset pipeline:</p> <ul> <li>All static assets are served from <code class="language-plaintext highlighter-rouge">priv/static</code> </li> <li>Javascript: webpack bundles from <code class="language-plaintext highlighter-rouge">assets/js</code> to <code class="language-plaintext highlighter-rouge">priv/static/js</code> </li> <li>CSS: webpack bundles from <code class="language-plaintext highlighter-rouge">assets/css</code> to <code class="language-plaintext highlighter-rouge">priv/static/css</code> </li> <li>Images and other assets: webpack copies from <code class="language-plaintext highlighter-rouge">assets/static</code> -&gt; <code class="language-plaintext highlighter-rouge">priv/static</code> </li> </ul> <p>Now with the new asset pipeline based on esbuild, all static assets are still served from <code class="language-plaintext highlighter-rouge">priv/static</code> directory, so the first item stays the same.</p> <p>With webpack gone, the other three obviously will change. For JS and CSS, esbuild will handle them; but we do need to deal with images and other assets separately.</p> <p>Alright, let’s dive into how to make those changes.</p> <h3 id="remove-webpack-config-and-related-node-files">Remove webpack config and related node files</h3> <p>First we need to remove webpack config and related node files:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>assets
<span class="nv">$ </span><span class="nb">rm </span>webpack.config.js package.json
     package-lock.json .babelrc
<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-rf</span> node_modules
</code></pre></div></div> <p>If you use yarn, remove <code class="language-plaintext highlighter-rouge">yarn.lock</code> instead of <code class="language-plaintext highlighter-rouge">package-lock.json</code>.</p> <h3 id="add-esbuild-in-deps">Add esbuild in deps</h3> <p>Then add <code class="language-plaintext highlighter-rouge">esbuild</code> as a dependency:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="o">...</span>
    <span class="p">{</span><span class="ss">:esbuild</span><span class="p">,</span> <span class="s2">"~&gt; 0.2"</span><span class="p">,</span> <span class="ss">runtime:</span> <span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span> <span class="o">==</span> <span class="ss">:dev</span><span class="p">},</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="configure-esbuild">Configure esbuild</h3> <p>Next add configuration for esbuild in <code class="language-plaintext highlighter-rouge">config/config.exs</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/config.exs</span>
<span class="n">config</span> <span class="ss">:esbuild</span><span class="p">,</span>
  <span class="ss">version:</span> <span class="s2">"0.12.18"</span><span class="p">,</span>
  <span class="ss">default:</span> <span class="p">[</span>
    <span class="ss">args:</span> <span class="sx">~w(js/app.js --bundle --target=es2016 --outdir=../priv/static/assets)</span><span class="p">,</span>
    <span class="ss">cd:</span> <span class="no">Path</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s2">"../assets"</span><span class="p">,</span> <span class="n">__DIR__</span><span class="p">),</span>
    <span class="ss">env:</span> <span class="p">%{</span><span class="s2">"NODE_PATH"</span> <span class="o">=&gt;</span> <span class="no">Path</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s2">"../deps"</span><span class="p">,</span> <span class="n">__DIR__</span><span class="p">)}</span>
  <span class="p">]</span>
</code></pre></div></div> <blockquote> <p>Note: here we are providing the relative path from <code class="language-plaintext highlighter-rouge">config</code> to <code class="language-plaintext highlighter-rouge">assets</code> with the <code class="language-plaintext highlighter-rouge">:cd</code> option, so that the esbuild command can be run in the <code class="language-plaintext highlighter-rouge">assets</code> directory. Given that, if you have a umbrella app, the path should be something like <code class="language-plaintext highlighter-rouge">../apps/your_web_app/assets</code>.</p> </blockquote> <h3 id="update-watcher-in-endpoint-configuration">Update watcher in endpoint configuration</h3> <p>In your <code class="language-plaintext highlighter-rouge">config/dev.exs</code> file, there should be a node watcher that uses webpack under the endpoint configuration. We want to replace that one with the esbuild watcher below:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/dev.exs</span>
<span class="n">config</span> <span class="ss">:your_web_app</span><span class="p">,</span> <span class="no">YourWebApp</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="o">...</span><span class="p">,</span>
  <span class="ss">watchers:</span> <span class="p">[</span>
    <span class="ss">esbuild:</span> <span class="p">{</span><span class="no">Esbuild</span><span class="p">,</span> <span class="ss">:install_and_run</span><span class="p">,</span> <span class="p">[</span><span class="ss">:default</span><span class="p">,</span> <span class="sx">~w(--sourcemap=inline --watch)</span><span class="p">]}</span>
  <span class="p">]</span>
</code></pre></div></div> <blockquote> <p>Note: this is for local development only.</p> </blockquote> <h3 id="move-images-and-other-assets">Move images and other assets</h3> <p>Then we deal with images.</p> <p>The following is not mentioned in the Phoenix 1.6 upgrade instructions, but I found <a href="https://www.reddit.com/r/elixir/comments/p9t68v/with_the_new_esbuild_transition_what_do_you_use/ha0cskv?context=3">José Valim’s recommendation</a> in a reddit thread.</p> <p>He recommends to move everything in <code class="language-plaintext highlighter-rouge">assets/static</code> to <code class="language-plaintext highlighter-rouge">priv/static</code>; stop ignoring <code class="language-plaintext highlighter-rouge">priv/static</code> and commit it in version control; also ignore <code class="language-plaintext highlighter-rouge">priv/static/assets</code> instead, since that’s where esbuild puts the compiled Javascript and CSS files.</p> <h3 id="add-assetsdeploy-mix-alias">Add <code class="language-plaintext highlighter-rouge">assets.deploy</code> mix alias</h3> <p>Then we add a new mix alias for deployment:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">aliases</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="s2">"assets.deploy"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"esbuild default --minify"</span><span class="p">,</span> <span class="s2">"phx.digest"</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <p>As we can see, it has two parts:</p> <ol> <li>esbuild will create minified Javascript and CSS and put them in <code class="language-plaintext highlighter-rouge">priv/static/assets</code> </li> <li>the <code class="language-plaintext highlighter-rouge">phx.digest</code> task will add digests for all static assets <code class="language-plaintext highlighter-rouge">priv/static</code> </li> </ol> <p>This is for deployment, so we only need to run it on build servers. For example when deploying to Heroku or the like, make sure it is run.</p> <p>If you did run it locally, it would generate a whole bunch of digested assets. Since we no longer ignore <code class="language-plaintext highlighter-rouge">priv/static</code>, they would show up when you run <code class="language-plaintext highlighter-rouge">git status</code> for example and could be annoying.</p> <p>We can remove them with the following command:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.digest.clean <span class="nt">--all</span>
</code></pre></div></div> <h3 id="update-layouts">Update layouts</h3> <p>As mentioned in the last section, esbuild puts compiled Javascript and CSS in <code class="language-plaintext highlighter-rouge">priv/static/assets</code> directory, so we need to update the references to them in the layouts, usually in <code class="language-plaintext highlighter-rouge">app.html.eex</code> or <code class="language-plaintext highlighter-rouge">root.html.eex</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># update</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/js/app.js"</span><span class="p">)</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/css/app.css"</span><span class="p">)</span>
<span class="c1"># to</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/assets/app.js"</span><span class="p">)</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/assets/app.css"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="update-plugstatic-configuration">Update <code class="language-plaintext highlighter-rouge">Plug.Static</code> configuration</h3> <p>Last step for the new asset pipeline is to update configuration for <code class="language-plaintext highlighter-rouge">Plug.Static</code>.</p> <p>We need to add the new <code class="language-plaintext highlighter-rouge">assets</code> directory in the <code class="language-plaintext highlighter-rouge">:only</code> option and also remove <code class="language-plaintext highlighter-rouge">js</code> and <code class="language-plaintext highlighter-rouge">css</code> from there since we no longer have them.</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Static</span><span class="p">,</span>
  <span class="ss">at:</span> <span class="s2">"/"</span><span class="p">,</span>
  <span class="ss">from:</span> <span class="ss">:my_app</span><span class="p">,</span>
  <span class="ss">gzip:</span> <span class="no">false</span><span class="p">,</span>
  <span class="ss">only:</span> <span class="sx">~w(assets fonts images favicon.ico robots.txt)</span>
</code></pre></div></div> <p>With the changes above, the new asset pipeline should be working, which means we are officially free of webpack and node in our Phoenix application <img class="emoji" title=":tada:" alt=":tada:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png" height="20" width="20"></p> <h2 id="migrate-to-heex-templates-optional">Migrate to <code class="language-plaintext highlighter-rouge">HEEx</code> templates (optional)</h2> <p>With Phoenix 1.6 the leex templates are deprecated and there is a new <code class="language-plaintext highlighter-rouge">HEEx</code> engine, which is being used in all the HTML files generated by <code class="language-plaintext highlighter-rouge">phx.new</code>, <code class="language-plaintext highlighter-rouge">phx.gen.html</code> etc.</p> <p>It is HTML-aware and it enforces valid markup. It’s also more strict for the Elixir expressions inside tags.</p> <p>In order to use it in an existing Phoenix project, make sure <code class="language-plaintext highlighter-rouge">phoenix_live_view</code> is added as a dependency, because the <code class="language-plaintext highlighter-rouge">HEEx</code> engine is part of <code class="language-plaintext highlighter-rouge">phoenix_live_view</code>.</p> <p>Then rename all the existing <code class="language-plaintext highlighter-rouge">.html.eex</code> and <code class="language-plaintext highlighter-rouge">.html.leex</code> templates to <code class="language-plaintext highlighter-rouge">.html.heex</code></p> <h3 id="update-elixir-expressions">Update Elixir expressions</h3> <p>When Elixir expressions appear in the body of HTML tags, <code class="language-plaintext highlighter-rouge">HEEx</code> templates use <code class="language-plaintext highlighter-rouge">&lt;%= ... %&gt;</code> for interpolation just like <code class="language-plaintext highlighter-rouge">EEx</code> templates.</p> <p>So code in the following example stays the same:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Hello</span> <span class="o">&lt;%=</span> <span class="nv">@name</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>

<span class="o">&lt;%=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="k">fn</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">name</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="p">%</span> <span class="k">end</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
</code></pre></div></div> <p>But when an Elixir expression is used inside a tag, as the attribute value for example:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s2">"&lt;%= @id %&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>It needs to be updated to:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="p">{</span><span class="nv">@id</span><span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Notice the <code class="language-plaintext highlighter-rouge">EEx</code> interpolation is inside double quotes, the curly braces are not. So the Elixir expression has to serve as the whole attribute value, not part of it.</p> <p>With <code class="language-plaintext highlighter-rouge">EEx</code>, the Elixir expression can serve as part of the attribute value:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/prefix/&lt;%= @item.text %&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>In situations like this, directly replacing it with a pair of curly braces won’t work.</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this doesn't work</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/prefix/{@item.text}"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>One way I could think of is to interpolate the original Elixir term in a string and then put that string in a pair of curly braces like the following:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="s2">"/prefix/</span><span class="si">#{</span><span class="nv">@item</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Now the resulting string is the Elixir expression and it serves as the whole attribute value, so this works.</p> <p>After making those changes, the new <code class="language-plaintext highlighter-rouge">HEEx</code> templates should be working.</p> <h2 id="deployment">Deployment</h2> <p>There are changes to the deployment process as well and I’ll cover that for Gigalixir, since that’s where my app is deployed to. But if you use Heroku, the changes should be fairly similar.</p> <p>Since we no longer use webpack and node to build assets, <code class="language-plaintext highlighter-rouge">phoenix_static_buildpack</code> is not necessary any more. We can just get rid of it.</p> <p>Also we need to make sure the <code class="language-plaintext highlighter-rouge">assets.deploy</code> task is run during deployment. We can use <code class="language-plaintext highlighter-rouge">hook_post_compile</code> in Elixir buildpack for that.</p> <p>Just add this line in your <code class="language-plaintext highlighter-rouge">elixir_buildpack.config</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hook_post_compile</span><span class="o">=</span><span class="s2">"eval mix assets.deploy &amp;&amp; rm -f _build/esbuild"</span>
</code></pre></div></div> <p>With those two changes, my app can be deployed to Gigalixir without any issue.</p> <p>If you’d like to deploy a new Phoenix 1.6 app to Gigalixir, check out the <a href="https://hexdocs.pm/phoenix/1.6.0-rc.0/gigalixir.html">full guide</a>.</p> <h2 id="new-generators">New generators</h2> <p>I’d like to quickly mention that Phoenix 1.6 also ships with two new generators:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">phx.gen.auth</code> generates a complete authentication solution for your application</li> <li> <code class="language-plaintext highlighter-rouge">phx.gen.notifier</code> generates a notifier for sending emails</li> </ul> <p>In my little app, I didn’t need to use them. But if you do need an authentication solution or a notifier, check them out.</p> <h2 id="summary">Summary</h2> <p>The release of Phoenix 1.6 is quite exciting, because by default webpack and node is replaced by esbuild. Now we can focus on developing the application in Elixir and Phoenix, without wasting time on breaking changes and nonsense security alerts in node dependencies.</p> <p>In this post, I walked through how I upgraded my humble little Phoenix app to 1.6, with a focus on updating the asset pipeline to use esbuild and migrating to <code class="language-plaintext highlighter-rouge">HEEx</code> templates. Hope this helps someone who’s trying to do the same.</p> <p>Phoenix 1.6 do have other new features that are not covered in this post. For those, make sure to check out the <a href="https://www.phoenixframework.org/">release note</a>.</p> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/elixir" class="page__taxonomy-item" rel="tag">elixir</a><span class="sep">, </span> <a href="/tags/esbuild" class="page__taxonomy-item" rel="tag">esbuild</a><span class="sep">, </span> <a href="/tags/phoenix" class="page__taxonomy-item" rel="tag">phoenix</a><span class="sep">, </span> <a href="/tags/webpack" class="page__taxonomy-item" rel="tag">webpack</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-09-28">September 28, 2021</time></p> </footer> <section class="page__share"> <h4 class="page__share-title">Share on</h4> <a href="https://twitter.com/intent/tweet?via=wiserfirst&amp;text=Journey+of+upgrading+an+app+to+Phoenix+1.6%20https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fupgrade-to-phoenix-16%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fupgrade-to-phoenix-16%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.wiserfirst.com%2Fblog%2Fupgrade-to-phoenix-16%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/setup-macbook-for-developers/" class="pagination--pager" title="Setup New Mac for Software Development ">Previous</a> <a href="/blog/pi-hole-on-raspberry-pi/" class="pagination--pager" title="Setup Pi-hole on Raspberry Pi ">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Leave a comment</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You may also enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2022-03-21/australia_nature_1440_420.jpg" alt="Australian Outback"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/different-perspective-for-elixir-macros/" rel="permalink">A Different Perspective for Elixir Macros </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2022-03-21T11:48:00+11:00">March 21, 2022</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 4 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Some random thoughts about Elixir Macros </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-10-18/pi_zero_1440_420.jpg" alt="Code with Elixir and Phoenix"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/pi-hole-on-raspberry-pi/" rel="permalink">Setup Pi-hole on Raspberry Pi </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-10-18T11:45:00+11:00">October 18, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 6 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Install in one place and protect your entire network </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-09-07/macbook_1440_400.jpg" alt="Macbook on desk"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/setup-macbook-for-developers/" rel="permalink">Setup New Mac for Software Development </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-09-07T11:35:00+10:00">September 7, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 4 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Step by step guide for setting up a new Mac computer </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-07-25/dice_1440_400.jpg" alt="Random array of dice"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/typescript-random-array-element/" rel="permalink">Get Random Array Element in Typescript </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-07-24T16:35:00+10:00">July 24, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 3 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Typescript Mini-patterns </p> </article> </div> </div> </div> </div> </div> <div class="search-content"> <div class="search-content__inner-wrap"> <form class="search-content__form" onkeydown="return event.key != 'Enter';"> <label class="sr-only" for="search"> Enter your search term... </label> <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..."> </form> <div id="results" class="results"></div> </div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li><strong>Follow:</strong></li> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">© 2023 Qing Wu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-174550807-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> <script>var disqus_config=function(){this.page.url="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/",this.page.identifier="/blog/upgrade-to-phoenix-16"};!function(){var t=document,e=t.createElement("script");e.src="https://wiserfirst.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> </body> </html>