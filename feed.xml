<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="https://www.wiserfirst.com/feed.xml" rel="self" type="application/atom+xml"/><link href="https://www.wiserfirst.com/" rel="alternate" type="text/html"/><updated>2022-12-31T22:47:19+11:00</updated><id>https://www.wiserfirst.com/feed.xml</id><title type="html">Peaceful Revolution</title><subtitle>Just another personal blog</subtitle><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><entry><title type="html">A Different Perspective for Elixir Macros</title><link href="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/" rel="alternate" type="text/html" title="A Different Perspective for Elixir Macros"/><published>2022-03-21T11:48:00+11:00</published><updated>2022-03-21T11:48:00+11:00</updated><id>https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros</id><content type="html" xml:base="https://www.wiserfirst.com/blog/different-perspective-for-elixir-macros/"><![CDATA[<p>In Elixir, macros are a way of metaprogramming, which is sometimes explained as something like “using code to write code”. While offering good intuition on what metaprogramming is about, it’s not very accurate, because it doesn’t actually write code.</p> <p>When trying to understand macros, I use the slightly different mental model: a macro is like a template with a name that can optionally have parameters; when the name is used, it’s substituted by the template with “values” of the arguments injected.</p> <p>Sorry if it didn’t make it better. I’ll try to explain what do I mean by that. But let’s first review how C macros work.</p> <h2 id="c-macos">C Macos</h2> <p>Before actually compiling a C program, the C compiler will use the C preprocessor to transform the program, which is also referred to as preprocessing. One of the things that happens in this preprocessing step is macro expansion.</p> <p>In GNU’s online documentation for <a href="https://gcc.gnu.org/onlinedocs/cpp/Macros.html">the C Preprocessor</a>, a macro is defined as following:</p> <blockquote> <p>A macro is a fragment of code which has been given a name. Whenever the name is used, it is replaced by the contents of the macro.</p> </blockquote> <p>You can define a macro like this:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define DOUBLE(x) (2 * x)
</span></code></pre></div></div> <blockquote> <p>NOTE: by convention macro names in C use uppercase.</p> </blockquote> <p>And then use it as below:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DOUBLE</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div> <p>During preprocessing, the preprocessor will replace it with <code class="language-plaintext highlighter-rouge">(2 * x)</code>. The compiler would just see <code class="language-plaintext highlighter-rouge">(2 * x)</code> as if you wrote it in stead of <code class="language-plaintext highlighter-rouge">DOUBLE(5)</code> in the first place.</p> <p>So a macro in C allows us to define a fragment of code that can have parameters, and when it’s used the macro name would be replaced by the code fragment we defined with arguments interpolated.</p> <p>It’s worth noting that since this happens before compilation, the program is still just a piece of text, so both arguments interpolation and macro expansion are just literal text substitution.</p> <p>How does this relate to Elixir’s macros? Well macro expansion in Elixir is definitely not text substitution, but it’s still substitution, just happens at a higher level.</p> <h2 id="the-abstract-syntax-tree-ast">The Abstract Syntax Tree (AST)</h2> <p>Most programming languages have the Abstract Syntax Tree (AST), which is a tree structure the compiler builds from the source code before turning it into either machine code or byte code.</p> <p>In most languages, the AST is not exposed to us developers and we can get our code working without worrying about the AST or even knowing about it.</p> <p>In the case of Elixir, the compiler give us access to the AST. This comes with great power and allows us to do many things that aren’t possible in other languages, creating macros among them.</p> <p>You can get the AST for a piece of code by using <code class="language-plaintext highlighter-rouge">quote</code>, for example:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iex</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span>
<span class="o">...</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span>
<span class="o">...</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">end</span>
<span class="p">{</span><span class="ss">:+</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]}</span>
</code></pre></div></div> <p>This is probably the simplest form, but in general Elixir’s AST is represented as a three elements tuple. When the expression is more complex, its corresponding AST is usually deeply nested.</p> <p>In Elixir, the AST is also known as quoted expressions.</p> <p>For more details on working with quoted expressions, please refer to offical <a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html">Quote and unquote</a> guide.</p> <h2 id="macros-in-elixir">Macros in Elixir</h2> <p>One thing to remember about macros in Elixir is that they receive AST as arguments and return AST.</p> <p>You can define a macro with <code class="language-plaintext highlighter-rouge">defmacro</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyIf</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">action</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">case</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">x</span> <span class="ow">when</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="no">false</span><span class="p">,</span> <span class="no">nil</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="no">nil</span>
        <span class="n">_</span> <span class="o">-&gt;</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then you can use it by:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">require</span> <span class="no">MyIf</span>

<span class="no">MyIf</span><span class="o">.</span><span class="k">if</span> <span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Hello world!"</span><span class="p">)</span>

<span class="c1"># or</span>

<span class="no">MyIf</span><span class="o">.</span><span class="k">if</span> <span class="no">false</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="s2">"Will not print anything"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="mental-models-about-macros">Mental models about Macros</h2> <h3 id="tree-metaphor">Tree Metaphor</h3> <p>To understand how macros work in general, I often use the tree metaphor. The entire program is just a big tree containing data and expressions as nodes, some of which are macro usages. This is literally correct with Elixir, because the compiler do convert the program into a big abstract syntax tree in the form of a deeply nested three elements tuple.</p> <p>Defining a macro is like creating a template in AST or say a sub-tree. If there are arguments, they can be injected to the sub-tree with <code class="language-plaintext highlighter-rouge">unquote</code>.</p> <p>During macro expansion, the Elixir compiler will replace each macro usage node with the AST sub-tree returned by its macro definition with the arguments injected. Because macros can be used inside another macro, macro expansion will happen repeatedly until there are no more macros.</p> <p>If we compare Elixir macros with C macros, we can see that they both offer a way to substitute an expression with a template. The difference is that in C we define the template as text and replaced as text, whereas in Elixir, the template is defined as a piece of AST and the substitution happens at the AST level as well.</p> <h3 id="copy-paste-metaphor">Copy-Paste Metaphor</h3> <p>To figure out what a particular macro does, I usually think of it as copying what the macro definition has and pasting it where the macro is being used. For unquoted arguments, mentally replace them with the corresponding values passed in.</p> <p>When the macro is more complex, this might not work, but it should still set one on the right path in understanding the macro.</p> <h2 id="summary">Summary</h2> <p>Macros are hard and they can be daunting even for experienced developers.</p> <p>In this short post, I tried to offer a different perspective in understanding macros in Elixir.</p> <p>It would fantastic if this makes it slightly easier for someone to learn about macros.</p> <p>If you’d like to learn more about Elixir macros, check out <a href="https://twitter.com/sasajuric">Saša Jurić</a>’s great blog post series <a href="https://www.theerlangelist.com/article/macros_1">Understanding Elixir Macros</a> and <a href="https://twitter.com/chris_mccord">Chris Mccord</a>’s book <a href="https://pragprog.com/titles/cmelixir/metaprogramming-elixir/">Metaprogramming Elixir</a>.</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="elixir"/><category term="macro"/><category term="tiny-tips"/><summary type="html"><![CDATA[Some random thoughts about Elixir Macros]]></summary></entry><entry><title type="html">Setup Pi-hole on Raspberry Pi</title><link href="https://www.wiserfirst.com/blog/pi-hole-on-raspberry-pi/" rel="alternate" type="text/html" title="Setup Pi-hole on Raspberry Pi"/><published>2021-10-18T11:45:00+11:00</published><updated>2021-10-18T11:45:00+11:00</updated><id>https://www.wiserfirst.com/blog/pi-hole-on-raspberry-pi</id><content type="html" xml:base="https://www.wiserfirst.com/blog/pi-hole-on-raspberry-pi/"><![CDATA[<p>According to its official documentation,</p> <blockquote> <p>The Pi-hole® is a DNS sinkhole that protects your devices from unwanted content, without installing any client-side software.</p> </blockquote> <p><a href="https://pi-hole.net/">Pi-hole</a> is a great piece of software if you are interested in a bit more privacy and saving some bandwidth at the same time.</p> <p>As its name suggests, it can obviously be installed on a Raspberry Pi, but apart from that it actually runs on other Linux hardware as well. As long as your device can run one of the <a href="https://docs.pi-hole.net/main/prerequisites/#supported-operating-systems">Officially supported Operating Systems</a>, you should be able to run Pi-hole on it.</p> <p>While supporting other hardware definitely has its use cases, I consider Raspberry Pi to be the best choice for running Pi-hole in the home network, because of its low cost and very low power consumption.</p> <p>I happen to have a <a href="https://www.raspberrypi.com/products/raspberry-pi-zero/">Raspberry Pi Zero</a> that’s been collecting dust since I bought it a few years ago, which is perfect for running Pi-hole.</p> <h2 id="install-os-on-raspberry-pi">Install OS on Raspberry Pi</h2> <p>Obviously we need to install an operating system on Raspberry Pi before we could do anything with it.</p> <p>The recommended way of installing an operating system for Raspberry Pi is to use the <a href="https://www.raspberrypi.com/software/">Raspberry Pi Imager</a>. You’ll need a computer with an micro SD card reader to install an OS image on your card.</p> <div style="margin: auto; text-align: center; width: 100%; max-width: 680px"> <figure style="display: block"> <img src="/assets/images/2021-10-18/pi_imager.png" alt="Raspberry Pi Imager Screenshot"/> <figcaption style="text-align: center;"> Raspberry Pi Imager Screenshot </figcaption> </figure> </div> <p>I’m running it on macOS, but it supports Linux and Windows as well. Just make sure to download the correct version for your OS.</p> <p>Click <code class="language-plaintext highlighter-rouge">CHOOSE OS</code> to choose from a list of options. I’d recommended just go with <code class="language-plaintext highlighter-rouge">Raspberry Pi OS (32-bit)</code>, which is the first option, unless you have a specific purpose for the Pi and you know what you are doing.</p> <p>Then click <code class="language-plaintext highlighter-rouge">CHOOSE STORAGE</code> to select the mounted micro SD card. Remember that the imager will erase the card first, so you’ll lost everything on the card. Make sure you’ve got backup for anything you still need on the card.</p> <p>Lastly, click <code class="language-plaintext highlighter-rouge">WRITE</code> to install the selected OS on your card.</p> <p>For most of the OS options, the imager will download the OS image while writing it to the micro SD card. If you have a slow Internet connect, you can also download the OS image separately from <a href="https://www.raspberrypi.com/software/operating-systems/">here</a> and then choose <code class="language-plaintext highlighter-rouge">Use custom</code> for the OS option and select the downloaded <code class="language-plaintext highlighter-rouge">.img</code> file.</p> <h3 id="advanced-options-for-the-imager">Advanced options for the imager</h3> <p>There is also an “Advanced” menu in the imager, which you can open with <code class="language-plaintext highlighter-rouge">Ctrl-Shift-X</code>. This menu allows you to perform tasks like enabling SSH and setting admin password. As described in the next section, we can do those with terminal commands too.</p> <h2 id="setup-raspberry-pi">Setup Raspberry Pi</h2> <p>Since I find connecting a monitor, a keyboard and a mouse to the Raspberry Pi quite cumbersome, I’d like to setup a headless Raspberry Pi.</p> <p>In order to achieve that, there are a couple more things to do before booting the Raspberry Pi: enable SSH access and allow auto WiFi connection.</p> <h3 id="enable-ssh-access">Enable SSH access</h3> <p>On macOS, the SD card with Raspberry Pi OS image is usually mounted on <code class="language-plaintext highlighter-rouge">/Volumes/boot</code>.</p> <p>We can enable SSH by creating an empty file named <code class="language-plaintext highlighter-rouge">ssh</code> in the root directory of the card:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /Volumes/boot
<span class="nb">touch </span>ssh
</code></pre></div></div> <h3 id="auto-wifi-connection">Auto WiFi connection</h3> <p>I’d also like the Pi to be able to connect to WiFi when it boots up.</p> <p>In order to do that, create a text file named <code class="language-plaintext highlighter-rouge">wpa_supplicant.conf</code> with the following content:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>country=&lt;your-country-code&gt;
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
network={
    ssid="&lt;your-wifi-ssid&gt;"
    psk="&lt;your-wifi-psk"
    key_mgmt=WPA-PSK
}
</code></pre></div></div> <p>Obviously, fill in the <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">ISO 3166 alpha-2 country code</a> of your country, your WiFi SSID and PSK.</p> <p>Then copy the file to the root directory of the SD card:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>wpa_supplicant.conf /Volumes/boot
</code></pre></div></div> <blockquote> <p>Note: if you are using an older Raspberry Pi (like my Pi Zero), it might not support 5GHz networks</p> </blockquote> <h3 id="connect-via-ssh">Connect via SSH</h3> <p>After the two steps above, we can put the SD card in the Raspberry Pi and boot it up.</p> <p>Once it’s up and running, we should be able to connect to it via SSH:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh pi@&lt;ip_for_raspberry_pi&gt;
</code></pre></div></div> <p>The default password is <code class="language-plaintext highlighter-rouge">raspberry</code>.</p> <p>Make sure to update the admin password with <code class="language-plaintext highlighter-rouge">passed</code> after logging in.</p> <h3 id="fix-locale">Fix locale</h3> <p>When you run commands on the Raspberry Pi, you may see warnings like this</p> <blockquote> <p>-bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)</p> </blockquote> <p>So you might want to fix the locale.</p> <p>If you are comfortable with <code class="language-plaintext highlighter-rouge">vi</code> or <code class="language-plaintext highlighter-rouge">nano</code>, just edit <code class="language-plaintext highlighter-rouge">/etc/locale.gen</code> and uncomment the line starting with <code class="language-plaintext highlighter-rouge">en_US.UTF-8</code>.</p> <p>Otherwise you can run the following command to do the same:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perl <span class="nt">-pi</span> <span class="nt">-e</span> <span class="s1">'s/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g'</span> /etc/locale.gen
</code></pre></div></div> <p>Then run the following:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>locale-gen en_US.UTF-8
update-locale en_US.UTF-8
</code></pre></div></div> <p>After that, the annoying warnings should be gone.</p> <p>Check out <a href="https://www.jaredwolff.com/raspberry-pi-setting-your-locale/">Jared Wolff’s post</a> for more details on locale.</p> <h2 id="install-pi-hole">Install Pi-hole</h2> <p>Now the Raspberry Pi is in a reasonable state, we are ready to install Pi-hole.</p> <p>The most convenient way to is to use the following command:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-sSL</span> https://install.pi-hole.net | bash
</code></pre></div></div> <p>The installation process is relatively straightforward. Just follow the prompts to get it done.</p> <p>If you’d like to know what the installation script actually does, check out the source code <a href="https://github.com/pi-hole/pi-hole/blob/master/automated%20install/basic-install.sh">basic-install.sh</a>.</p> <h3 id="take-advantage-of-pi-hole-in-the-network">Take advantage of Pi-hole in the network</h3> <p>After Pi-hole is successfully installed, we still need to configure the router to use Pi-hole as the DNS server, which makes sure that all devices on the network will be protected automatically by Pi-hole.</p> <p>If that’s not supported by your router or you only want certain devices to use Pi-hole, you can configure the DNS server on each device.</p> <p>You might want to check out <a href="https://discourse.pi-hole.net/t/how-do-i-configure-my-devices-to-use-pi-hole-as-their-dns-server/245">this comprehensive guide</a> on the different options to configure Pi-hole as your DNS server.</p> <h3 id="manage-blocklists">Manage blocklists</h3> <p>Pi-hole comes with a default blocklist:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts
</code></pre></div></div> <p>Which is well maintained and provides good protection without breaking normal functionality in most cases. For many this might be enough, but if you have other requirements, such as blocking adult content or targeted ads, you can add custom blocklists for improved blocking capabilities.</p> <p>Check out <a href="https://avoidthehack.com/best-pihole-blocklists">The Best PiHole Blocklists (2021)</a> for some blocklist options and more importantly, what to think about when choosing a blocklist.</p> <p>You can add/remove blocklists under <code class="language-plaintext highlighter-rouge">Group Management -&gt; Adlists</code> in the Pi-hole admin interface. After making changes there, you’ll need to either run <code class="language-plaintext highlighter-rouge">pihole -g</code> in terminal or go to <code class="language-plaintext highlighter-rouge">Tools -&gt; Update Gravity</code> and click the <code class="language-plaintext highlighter-rouge">Update</code> button.</p> <h3 id="whitelist-youtube-history-and-etc">Whitelist Youtube history and etc</h3> <p>With the default blocklist from Pi-hole, the only thing that no longer works for me is Youtube history on iOS devices.</p> <p>Adding a domain to the whitelist would solve that:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pihole <span class="nt">-w</span> s.youtube.com
</code></pre></div></div> <p>Or if you prefer the admin interface, you can add a domain in <code class="language-plaintext highlighter-rouge">Whitelist</code>.</p> <p>If you find other sites or services not working properly after introducing Pi-hole, you might want to check out the <a href="https://discourse.pi-hole.net/t/commonly-whitelisted-domains/212">Commonly Whitelisted Domains</a> and potentially whitelist relevant domains.</p> <h2 id="keep-software-up-to-date">Keep software up-to-date</h2> <p>Last but not least, keeping things up-to-date on the Raspberry Pi would be a good idea.</p> <p>Since Raspberry Pi OS is based on Debian Linux, we can use <code class="language-plaintext highlighter-rouge">apt</code> for that:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt full-upgrade
</code></pre></div></div> <p>Also we can remove packages that are no longer required with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt autoremove
</code></pre></div></div> <h2 id="summary">Summary</h2> <p>In this post, I walked through how to install Raspberry Pi OS, setup headless Raspberry Pi, install Pi-hole, manage blocklists and etc.</p> <p>As many of my other posts, the main purpose is to serve as a reference for my future self. But if someone else finds it helpful too, I’d be very glad :slightly_smiling_face:</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="adblock"/><category term="debian"/><category term="pi-hole"/><category term="raspberry-pi"/><summary type="html"><![CDATA[Install in one place and protect your entire network]]></summary></entry><entry><title type="html">Journey of upgrading an app to Phoenix 1.6</title><link href="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/" rel="alternate" type="text/html" title="Journey of upgrading an app to Phoenix 1.6"/><published>2021-09-19T12:25:00+10:00</published><updated>2021-09-28T12:05:00+10:00</updated><id>https://www.wiserfirst.com/blog/upgrade-to-phoenix-16</id><content type="html" xml:base="https://www.wiserfirst.com/blog/upgrade-to-phoenix-16/"><![CDATA[<p>Phoenix 1.6 RC0 was released just over three weeks ago and I’m really excited about it. Because it provides the option to replace webpack with esbuild, so that we no longer need Node for asset building.</p> <p>True that it’s just the first release candidate, but we are still one step closer to the formal release.</p> <blockquote> <p><strong>Update (28 September 2021):</strong> <a href="https://github.com/phoenixframework/phoenix/releases/tag/v1.6.0">Phoenix 1.6.0</a> was released three days ago on 25 September, so now we do have our formal release</p> </blockquote> <p>Last week, I managed to upgrade my little side project <a href="https://github.com/wiserfirst/rubiks_cube_algs_trainer">Rubik’s Cube Algorithms Trainer</a> to Phoenix 1.6 and I’ll share my journey in this post. For the most part, I was following the <a href="https://gist.github.com/chrismccord/2ab350f154235ad4a4d0f4de6decba7b">Phoenix 1.5.x to 1.6 upgrade instructions</a> by <a href="https://twitter.com/chris_mccord">Chris McCord</a>.</p> <p>If you prefer watching a video than reading, I also did a talk about it at <a href="https://www.meetup.com/elixir-sydney/events/gztkjsyccmbtb/">Elixir Sydney September 2021 meetup</a> and the recording is on <a href="https://www.youtube.com/watch?v=NR_Jk3yUEqc">Youtube</a>.</p> <h2 id="update-dependencies-in-mixfile">Update dependencies in Mixfile</h2> <p>First we need to update the dependencies in the <code class="language-plaintext highlighter-rouge">mix.exs</code> file:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:phoenix</span><span class="p">,</span> <span class="s2">"~&gt; 1.6.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_html</span><span class="p">,</span> <span class="s2">"~&gt; 3.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_view</span><span class="p">,</span> <span class="s2">"~&gt; 0.16.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:phoenix_live_dashboard</span><span class="p">,</span> <span class="s2">"~&gt; 0.5"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:telemetry_metrics</span><span class="p">,</span> <span class="s2">"~&gt; 0.6"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:telemetry_poller</span><span class="p">,</span> <span class="s2">"~&gt; 0.5"</span><span class="p">},</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then run <code class="language-plaintext highlighter-rouge">mix deps.get</code> to install the new dependencies.</p> <p>Two thing to note here:</p> <ul> <li><del>For <code class="language-plaintext highlighter-rouge">phoenix</code>, the <code class="language-plaintext highlighter-rouge">override: true</code> option is important, because Phoenix 1.6 is still in RC</del> (This is no longer the case, since Phoenix 1.6.0 has been released)</li> <li>If you want to use the new <code class="language-plaintext highlighter-rouge">HEEx</code> templates, add <code class="language-plaintext highlighter-rouge">phoenix_live_view</code> even if you don’t actually use live view</li> </ul> <h2 id="esbuild-for-javascript-and-css-bundling-optional">esbuild for Javascript and CSS bundling (optional)</h2> <p>Next step is to use esbuild for Javascript and CSS bundling. This is an optional step in upgrading to Phoenix 1.6, but it is what I’m all excited about, so it’s not optional for me :smirk:</p> <h3 id="phoenix-asset-pipeline-overview">Phoenix asset pipeline overview</h3> <p>Before jumping into replacing webpack with esbuild, it’s worth having a quick review of the existing Phoenix asset pipeline:</p> <ul> <li>All static assets are served from <code class="language-plaintext highlighter-rouge">priv/static</code></li> <li>Javascript: webpack bundles from <code class="language-plaintext highlighter-rouge">assets/js</code> to <code class="language-plaintext highlighter-rouge">priv/static/js</code></li> <li>CSS: webpack bundles from <code class="language-plaintext highlighter-rouge">assets/css</code> to <code class="language-plaintext highlighter-rouge">priv/static/css</code></li> <li>Images and other assets: webpack copies from <code class="language-plaintext highlighter-rouge">assets/static</code> -&gt; <code class="language-plaintext highlighter-rouge">priv/static</code></li> </ul> <p>Now with the new asset pipeline based on esbuild, all static assets are still served from <code class="language-plaintext highlighter-rouge">priv/static</code> directory, so the first item stays the same.</p> <p>With webpack gone, the other three obviously will change. For JS and CSS, esbuild will handle them; but we do need to deal with images and other assets separately.</p> <p>Alright, let’s dive into how to make those changes.</p> <h3 id="remove-webpack-config-and-related-node-files">Remove webpack config and related node files</h3> <p>First we need to remove webpack config and related node files:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>assets
<span class="nv">$ </span><span class="nb">rm </span>webpack.config.js package.json
     package-lock.json .babelrc
<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-rf</span> node_modules
</code></pre></div></div> <p>If you use yarn, remove <code class="language-plaintext highlighter-rouge">yarn.lock</code> instead of <code class="language-plaintext highlighter-rouge">package-lock.json</code>.</p> <h3 id="add-esbuild-in-deps">Add esbuild in deps</h3> <p>Then add <code class="language-plaintext highlighter-rouge">esbuild</code> as a dependency:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="o">...</span>
    <span class="p">{</span><span class="ss">:esbuild</span><span class="p">,</span> <span class="s2">"~&gt; 0.2"</span><span class="p">,</span> <span class="ss">runtime:</span> <span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">()</span> <span class="o">==</span> <span class="ss">:dev</span><span class="p">},</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="configure-esbuild">Configure esbuild</h3> <p>Next add configuration for esbuild in <code class="language-plaintext highlighter-rouge">config/config.exs</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/config.exs</span>
<span class="n">config</span> <span class="ss">:esbuild</span><span class="p">,</span>
  <span class="ss">version:</span> <span class="s2">"0.12.18"</span><span class="p">,</span>
  <span class="ss">default:</span> <span class="p">[</span>
    <span class="ss">args:</span> <span class="sx">~w(js/app.js --bundle --target=es2016 --outdir=../priv/static/assets)</span><span class="p">,</span>
    <span class="ss">cd:</span> <span class="no">Path</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s2">"../assets"</span><span class="p">,</span> <span class="n">__DIR__</span><span class="p">),</span>
    <span class="ss">env:</span> <span class="p">%{</span><span class="s2">"NODE_PATH"</span> <span class="o">=&gt;</span> <span class="no">Path</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s2">"../deps"</span><span class="p">,</span> <span class="n">__DIR__</span><span class="p">)}</span>
  <span class="p">]</span>
</code></pre></div></div> <blockquote> <p>Note: here we are providing the relative path from <code class="language-plaintext highlighter-rouge">config</code> to <code class="language-plaintext highlighter-rouge">assets</code> with the <code class="language-plaintext highlighter-rouge">:cd</code> option, so that the esbuild command can be run in the <code class="language-plaintext highlighter-rouge">assets</code> directory. Given that, if you have a umbrella app, the path should be something like <code class="language-plaintext highlighter-rouge">../apps/your_web_app/assets</code>.</p> </blockquote> <h3 id="update-watcher-in-endpoint-configuration">Update watcher in endpoint configuration</h3> <p>In your <code class="language-plaintext highlighter-rouge">config/dev.exs</code> file, there should be a node watcher that uses webpack under the endpoint configuration. We want to replace that one with the esbuild watcher below:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/dev.exs</span>
<span class="n">config</span> <span class="ss">:your_web_app</span><span class="p">,</span> <span class="no">YourWebApp</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="o">...</span><span class="p">,</span>
  <span class="ss">watchers:</span> <span class="p">[</span>
    <span class="ss">esbuild:</span> <span class="p">{</span><span class="no">Esbuild</span><span class="p">,</span> <span class="ss">:install_and_run</span><span class="p">,</span> <span class="p">[</span><span class="ss">:default</span><span class="p">,</span> <span class="sx">~w(--sourcemap=inline --watch)</span><span class="p">]}</span>
  <span class="p">]</span>
</code></pre></div></div> <blockquote> <p>Note: this is for local development only.</p> </blockquote> <h3 id="move-images-and-other-assets">Move images and other assets</h3> <p>Then we deal with images.</p> <p>The following is not mentioned in the Phoenix 1.6 upgrade instructions, but I found <a href="https://www.reddit.com/r/elixir/comments/p9t68v/with_the_new_esbuild_transition_what_do_you_use/ha0cskv?context=3">José Valim’s recommendation</a> in a reddit thread.</p> <p>He recommends to move everything in <code class="language-plaintext highlighter-rouge">assets/static</code> to <code class="language-plaintext highlighter-rouge">priv/static</code>; stop ignoring <code class="language-plaintext highlighter-rouge">priv/static</code> and commit it in version control; also ignore <code class="language-plaintext highlighter-rouge">priv/static/assets</code> instead, since that’s where esbuild puts the compiled Javascript and CSS files.</p> <h3 id="add-assetsdeploy-mix-alias">Add <code class="language-plaintext highlighter-rouge">assets.deploy</code> mix alias</h3> <p>Then we add a new mix alias for deployment:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">aliases</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="s2">"assets.deploy"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"esbuild default --minify"</span><span class="p">,</span> <span class="s2">"phx.digest"</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <p>As we can see, it has two parts:</p> <ol> <li>esbuild will create minified Javascript and CSS and put them in <code class="language-plaintext highlighter-rouge">priv/static/assets</code></li> <li>the <code class="language-plaintext highlighter-rouge">phx.digest</code> task will add digests for all static assets <code class="language-plaintext highlighter-rouge">priv/static</code></li> </ol> <p>This is for deployment, so we only need to run it on build servers. For example when deploying to Heroku or the like, make sure it is run.</p> <p>If you did run it locally, it would generate a whole bunch of digested assets. Since we no longer ignore <code class="language-plaintext highlighter-rouge">priv/static</code>, they would show up when you run <code class="language-plaintext highlighter-rouge">git status</code> for example and could be annoying.</p> <p>We can remove them with the following command:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.digest.clean <span class="nt">--all</span>
</code></pre></div></div> <h3 id="update-layouts">Update layouts</h3> <p>As mentioned in the last section, esbuild puts compiled Javascript and CSS in <code class="language-plaintext highlighter-rouge">priv/static/assets</code> directory, so we need to update the references to them in the layouts, usually in <code class="language-plaintext highlighter-rouge">app.html.eex</code> or <code class="language-plaintext highlighter-rouge">root.html.eex</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># update</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/js/app.js"</span><span class="p">)</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/css/app.css"</span><span class="p">)</span>
<span class="c1"># to</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/assets/app.js"</span><span class="p">)</span>
<span class="no">Routes</span><span class="o">.</span><span class="n">static_path</span><span class="p">(</span><span class="nv">@conn</span><span class="p">,</span> <span class="s2">"/assets/app.css"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="update-plugstatic-configuration">Update <code class="language-plaintext highlighter-rouge">Plug.Static</code> configuration</h3> <p>Last step for the new asset pipeline is to update configuration for <code class="language-plaintext highlighter-rouge">Plug.Static</code>.</p> <p>We need to add the new <code class="language-plaintext highlighter-rouge">assets</code> directory in the <code class="language-plaintext highlighter-rouge">:only</code> option and also remove <code class="language-plaintext highlighter-rouge">js</code> and <code class="language-plaintext highlighter-rouge">css</code> from there since we no longer have them.</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Static</span><span class="p">,</span>
  <span class="ss">at:</span> <span class="s2">"/"</span><span class="p">,</span>
  <span class="ss">from:</span> <span class="ss">:my_app</span><span class="p">,</span>
  <span class="ss">gzip:</span> <span class="no">false</span><span class="p">,</span>
  <span class="ss">only:</span> <span class="sx">~w(assets fonts images favicon.ico robots.txt)</span>
</code></pre></div></div> <p>With the changes above, the new asset pipeline should be working, which means we are officially free of webpack and node in our Phoenix application :tada:</p> <h2 id="migrate-to-heex-templates-optional">Migrate to <code class="language-plaintext highlighter-rouge">HEEx</code> templates (optional)</h2> <p>With Phoenix 1.6 the leex templates are deprecated and there is a new <code class="language-plaintext highlighter-rouge">HEEx</code> engine, which is being used in all the HTML files generated by <code class="language-plaintext highlighter-rouge">phx.new</code>, <code class="language-plaintext highlighter-rouge">phx.gen.html</code> etc.</p> <p>It is HTML-aware and it enforces valid markup. It’s also more strict for the Elixir expressions inside tags.</p> <p>In order to use it in an existing Phoenix project, make sure <code class="language-plaintext highlighter-rouge">phoenix_live_view</code> is added as a dependency, because the <code class="language-plaintext highlighter-rouge">HEEx</code> engine is part of <code class="language-plaintext highlighter-rouge">phoenix_live_view</code>.</p> <p>Then rename all the existing <code class="language-plaintext highlighter-rouge">.html.eex</code> and <code class="language-plaintext highlighter-rouge">.html.leex</code> templates to <code class="language-plaintext highlighter-rouge">.html.heex</code></p> <h3 id="update-elixir-expressions">Update Elixir expressions</h3> <p>When Elixir expressions appear in the body of HTML tags, <code class="language-plaintext highlighter-rouge">HEEx</code> templates use <code class="language-plaintext highlighter-rouge">&lt;%= ... %&gt;</code> for interpolation just like <code class="language-plaintext highlighter-rouge">EEx</code> templates.</p> <p>So code in the following example stays the same:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;</span><span class="no">Hello</span> <span class="o">&lt;%=</span> <span class="nv">@name</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>

<span class="o">&lt;%=</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="k">fn</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">name</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="p">%</span> <span class="k">end</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
</code></pre></div></div> <p>But when an Elixir expression is used inside a tag, as the attribute value for example:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s2">"&lt;%= @id %&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>It needs to be updated to:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="p">{</span><span class="nv">@id</span><span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Notice the <code class="language-plaintext highlighter-rouge">EEx</code> interpolation is inside double quotes, the curly braces are not. So the Elixir expression has to serve as the whole attribute value, not part of it.</p> <p>With <code class="language-plaintext highlighter-rouge">EEx</code>, the Elixir expression can serve as part of the attribute value:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/prefix/&lt;%= @item.text %&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>In situations like this, directly replacing it with a pair of curly braces won’t work.</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this doesn't work</span>
<span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/prefix/{@item.text}"</span><span class="o">&gt;</span>
</code></pre></div></div> <p>One way I could think of is to interpolate the original Elixir term in a string and then put that string in a pair of curly braces like the following:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="s2">"/prefix/</span><span class="si">#{</span><span class="nv">@item</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">"</span><span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Now the resulting string is the Elixir expression and it serves as the whole attribute value, so this works.</p> <p>After making those changes, the new <code class="language-plaintext highlighter-rouge">HEEx</code> templates should be working.</p> <h2 id="deployment">Deployment</h2> <p>There are changes to the deployment process as well and I’ll cover that for Gigalixir, since that’s where my app is deployed to. But if you use Heroku, the changes should be fairly similar.</p> <p>Since we no longer use webpack and node to build assets, <code class="language-plaintext highlighter-rouge">phoenix_static_buildpack</code> is not necessary any more. We can just get rid of it.</p> <p>Also we need to make sure the <code class="language-plaintext highlighter-rouge">assets.deploy</code> task is run during deployment. We can use <code class="language-plaintext highlighter-rouge">hook_post_compile</code> in Elixir buildpack for that.</p> <p>Just add this line in your <code class="language-plaintext highlighter-rouge">elixir_buildpack.config</code>:</p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hook_post_compile</span><span class="o">=</span><span class="s2">"eval mix assets.deploy &amp;&amp; rm -f _build/esbuild"</span>
</code></pre></div></div> <p>With those two changes, my app can be deployed to Gigalixir without any issue.</p> <p>If you’d like to deploy a new Phoenix 1.6 app to Gigalixir, check out the <a href="https://hexdocs.pm/phoenix/1.6.0-rc.0/gigalixir.html">full guide</a>.</p> <h2 id="new-generators">New generators</h2> <p>I’d like to quickly mention that Phoenix 1.6 also ships with two new generators:</p> <ul> <li><code class="language-plaintext highlighter-rouge">phx.gen.auth</code> generates a complete authentication solution for your application</li> <li><code class="language-plaintext highlighter-rouge">phx.gen.notifier</code> generates a notifier for sending emails</li> </ul> <p>In my little app, I didn’t need to use them. But if you do need an authentication solution or a notifier, check them out.</p> <h2 id="summary">Summary</h2> <p>The release of Phoenix 1.6 is quite exciting, because by default webpack and node is replaced by esbuild. Now we can focus on developing the application in Elixir and Phoenix, without wasting time on breaking changes and nonsense security alerts in node dependencies.</p> <p>In this post, I walked through how I upgraded my humble little Phoenix app to 1.6, with a focus on updating the asset pipeline to use esbuild and migrating to <code class="language-plaintext highlighter-rouge">HEEx</code> templates. Hope this helps someone who’s trying to do the same.</p> <p>Phoenix 1.6 do have other new features that are not covered in this post. For those, make sure to check out the <a href="https://www.phoenixframework.org/">release note</a>.</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="elixir"/><category term="esbuild"/><category term="phoenix"/><category term="webpack"/><summary type="html"><![CDATA[Say goodbye to webpack and Node in your Phoenix applications]]></summary></entry><entry><title type="html">Setup New Mac for Software Development</title><link href="https://www.wiserfirst.com/blog/setup-macbook-for-developers/" rel="alternate" type="text/html" title="Setup New Mac for Software Development"/><published>2021-09-07T11:35:00+10:00</published><updated>2021-09-18T12:50:00+10:00</updated><id>https://www.wiserfirst.com/blog/setup-macbook-for-developers</id><content type="html" xml:base="https://www.wiserfirst.com/blog/setup-macbook-for-developers/"><![CDATA[<p>Many software developers use Mac computers for work or personal use. To start on a new Mac, the most convenient option is to transfer from an existing Mac or restore from a Time Machine backup. But from time to time, we still need to set it up as a brand new computer, maybe because an existing Mac isn’t available or we simply want to start fresh with the new laptop.</p> <p>In this post, I’ll document what I consider the best way to setup a brand new Mac for software development. The primary purpose is to serve as a reference for my future self, but if some readers find it useful, that would be awesome too.</p> <p>These are just based on my personal experience, so there is no guarantee they’ll work well for you too. If you find other better ways to do certain steps, please let me know in the public comment below or reach out to me directly.</p> <h2 id="step-1-install-homebrew">Step 1: Install Homebrew</h2> <p>I use Homebrew to install and manage most of command line tools and GUI apps.</p> <p>Install it with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/bash <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsSL</span> https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span class="si">)</span><span class="s2">"</span>
</code></pre></div></div> <p>This script is quite intelligent. It works on Intel or Apple Silicon based Macs and even Linux, and it installs Homebrew to different preferred prefixes based on the situation. For more information, please refer to the <a href="https://docs.brew.sh/Installation">Homebrew Installation guide</a>.</p> <h2 id="step-2-brew-bundle">Step 2: brew bundle</h2> <p>Manually installing all the packages needed on a new Mac is tedious, but luckily we don’t have to do that thanks to <a href="https://github.com/Homebrew/homebrew-bundle">Homebrew Bundle</a>.</p> <p>One can create a <code class="language-plaintext highlighter-rouge">Brewfile</code> with <code class="language-plaintext highlighter-rouge">brew bundle dump</code> and then run <code class="language-plaintext highlighter-rouge">brew bundle</code> to install and upgrade all packages from the <code class="language-plaintext highlighter-rouge">Brewfile</code>. For more details, please refer to <a href="https://docs.brew.sh/Manpage#bundle-subcommand">the <code class="language-plaintext highlighter-rouge">brew bundle</code> section of the <code class="language-plaintext highlighter-rouge">brew man</code> output</a> or <code class="language-plaintext highlighter-rouge">brew bundle --help</code>.</p> <p>I’ve saved a <code class="language-plaintext highlighter-rouge">Brewfile</code> to my <code class="language-plaintext highlighter-rouge">dotfiles</code> repository on Github, so I can just download it with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-fL</span> <span class="nt">-o</span> Brewfile https://raw.githubusercontent.com/wiserfirst/dotfiles/master/Brewfile
</code></pre></div></div> <p>And then run <code class="language-plaintext highlighter-rouge">brew bundle</code> to install the packages.</p> <h2 id="step-3-add-ssh-key-to-github">Step 3: Add SSH key to Github</h2> <p>The next couple steps involve cloning from Github, so generating a new SSH key and adding it to my Github account is necessary.</p> <h3 id="generate-new-ssh-key">Generate new SSH key</h3> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-C</span> <span class="s2">"your_email@example.com"</span>
</code></pre></div></div> <p>Reference: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Generating a new SSH key and adding it to the ssh-agent</a></p> <h3 id="add-to-github-account">Add to Github account</h3> <p>First copy your SSH public key to clipboard with</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pbcopy &lt; ~/.ssh/id_ed25519.pub
</code></pre></div></div> <p>Then login to your Github account, go to Settings -&gt; SSH and GPG keys -&gt; New SSH key. Give it a title and paste your key into the “Key” field.</p> <p>Reference: <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account">Adding a new SSH key to your Github account</a></p> <h2 id="step-4-install-my-dotfiles">Step 4: Install my dotfiles</h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:wiserfirst/dotfiles.git
<span class="nb">cd </span>dotfiles
ruby ./install.rb
</code></pre></div></div> <h2 id="step-5-install-maximum-awesome">Step 5: Install maximum-awesome</h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:wiserfirst/maximum-awesome.git
<span class="nb">cd </span>maximum-awesome
git checkout qing
rake
</code></pre></div></div> <p>For installing Vim plugins separately, just run <code class="language-plaintext highlighter-rouge">:PlugInstall</code> in Vim.</p> <h2 id="step-6-install-asdf-vm-and-programming-languages">Step 6: Install asdf-vm and programming languages</h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/asdf-vm/asdf.git ~/.asdf <span class="nt">--branch</span> v0.8.1
</code></pre></div></div> <p>If you don’t already have this in your zshrc, the following is needed:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'\n. $HOME/.asdf/asdf.sh'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'\n. $HOME/.asdf/completions/asdf.bash'</span> <span class="o">&gt;&gt;</span> ~/.zshrc
</code></pre></div></div> <p>Now I’d like to install Erlang and Elixir:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin-add erlang
asdf plugin-add elixir
<span class="c"># actual Openssl version depends on what's in `brew list`</span>
<span class="nb">export </span><span class="nv">KERL_CONFIGURE_OPTIONS</span><span class="o">=</span><span class="s2">"--without-javac --with-ssl=</span><span class="si">$(</span>brew <span class="nt">--prefix</span> openssl@1.1<span class="si">)</span><span class="s2">"</span>
asdf <span class="nb">install </span>erlang 23.3.4
asdf <span class="nb">install </span>elixir 1.12.3
asdf global erlang 23.3.4
asdf global elixir 1.12.3
</code></pre></div></div> <p>Obviously you could install whatever programming languages you need, be that Ruby, Node.js, Python or something else.</p> <p>For more details on how to do that with asdf, check out my comprehensive guide: <a href="/blog/how-to-use-asdf-on-macos/">How to Use asdf Version Manager on macOS</a>.</p> <h2 id="step-7-install-prezto-and-set-zsh-as-default-shell">Step 7: Install prezto and set zsh as default shell</h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">--recursive</span> https://github.com/sorin-ionescu/prezto.git <span class="s2">"</span><span class="k">${</span><span class="nv">ZDOTDIR</span><span class="k">:-</span><span class="nv">$HOME</span><span class="k">}</span><span class="s2">/.zprezto"</span>
setopt EXTENDED_GLOB
<span class="k">for </span>rcfile <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ZDOTDIR</span><span class="k">:-</span><span class="nv">$HOME</span><span class="k">}</span><span class="s2">"</span>/.zprezto/runcoms/^README.md<span class="o">(</span>.N<span class="o">)</span><span class="p">;</span> <span class="k">do
  </span><span class="nb">ln</span> <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$rcfile</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ZDOTDIR</span><span class="k">:-</span><span class="nv">$HOME</span><span class="k">}</span><span class="s2">/.</span><span class="k">${</span><span class="nv">rcfile</span>:t<span class="k">}</span><span class="s2">"</span>
<span class="k">done
</span><span class="nb">sudo </span>chsh <span class="nt">-s</span> /bin/zsh
</code></pre></div></div> <h2 id="step-8-install-fzf">Step 8: Install fzf</h2> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">--depth</span> 1 https://github.com/junegunn/fzf.git ~/.fzf
~/.fzf/install
</code></pre></div></div> <h2 id="step-10-preferences-in-gui">Step 10: Preferences in GUI</h2> <ul> <li>iTerm <ul> <li>Profiles -&gt; Colors -&gt; Color Presets -&gt; Solarized Dark</li> <li>Profiles -&gt; Text -&gt; Font -&gt; Size to 14</li> <li>Profiles -&gt; Terminal -&gt; Scrollback Buffer -&gt; tick “Unlimited scrollback”</li> </ul> </li> <li>System Preferences <ul> <li>Keyboard -&gt; Modifier Keys -&gt; Map “Caps lock” key to Escape</li> <li>Trackpad -&gt; Point &amp; Click -&gt; tick “Tap to click”</li> <li>Accessibility -&gt; Pointer Control -&gt; Trackpad Options -&gt; tick “Enable dragging” -&gt; three finger drag</li> <li>(Optional for external monitor) Displays -&gt; (on the external monitor) Option + click “Scaled” and choose 2560 x 1440</li> </ul> </li> </ul> <h2 id="step-11-ignore-new-system-update-optional">Step 11: Ignore new system update (optional)</h2> <p>If you are not ready to upgrade to the latest version of macOS, you can stop it from showing up in System Preferences -&gt; Software Update with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/sbin/softwareupdate <span class="nt">--ignore</span> <span class="s2">"macOS [version name]"</span>
</code></pre></div></div> <p>Here <code class="language-plaintext highlighter-rouge">version name</code> could be <code class="language-plaintext highlighter-rouge">Catalina</code>, <code class="language-plaintext highlighter-rouge">Big Sur</code> or <code class="language-plaintext highlighter-rouge">Monterey</code>, depending on which you’d like to ignore.</p> <p>When you are ready to install the new version, just restore it with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /usr/sbin/softwareupdate <span class="nt">--reset-ignored</span>
</code></pre></div></div> <h2 id="summary">Summary</h2> <p>After following the steps in this post, there may be things you still need to install or tweak, but the new Mac should be fairly close to be ready as the primary development machine.</p> <p>Surely, these steps are going to evolve over time and I’ll try my best to keep them up-to-date. But again, I don’t do this very often, so they may get out of date.</p> <p>Anyway, please feel free to take what you need and let me know what you think :slightly_smiling_face:</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="Apple"/><category term="Mac"/><category term="macos"/><summary type="html"><![CDATA[Step by step guide for setting up a new Mac computer]]></summary></entry><entry><title type="html">Get Random Array Element in Typescript</title><link href="https://www.wiserfirst.com/blog/typescript-random-array-element/" rel="alternate" type="text/html" title="Get Random Array Element in Typescript"/><published>2021-07-24T16:35:00+10:00</published><updated>2021-07-24T16:35:00+10:00</updated><id>https://www.wiserfirst.com/blog/typescript-random-array-element</id><content type="html" xml:base="https://www.wiserfirst.com/blog/typescript-random-array-element/"><![CDATA[<p>Recently I needed to be able to get a random element from an array. It was slightly surprising to me that the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">Javascript Array class</a> doesn’t provide a built-in function for that.</p> <p>In this post I talks about how I built a function to do that and also compared with the <code class="language-plaintext highlighter-rouge">_.sample</code> function from the popular Javascript library <a href="https://www.npmjs.com/package/lodash">lodash</a>.</p> <h2 id="initial-implementation">Initial Implementation</h2> <p>I’m building it in Typescript, since the project I am working on already uses Typescript.</p> <p>The function takes an array and returns a random element from it. The type of array element doesn’t matter here. So the function signature should be something like this:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="kr">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="kr">any</span>
</code></pre></div></div> <p>For an array, the lowest valid index is <code class="language-plaintext highlighter-rouge">0</code> and the highest valid index is <code class="language-plaintext highlighter-rouge">arr.length - 1</code>. I could generate an random integer between <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">arr.length - 1</code>. Then if I use that number as index for the array, I could get back a random element. That should look like this:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</code></pre></div></div> <p>So we have our function:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getRandomElement</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="kr">any</span><span class="p">[])</span> <span class="o">=&gt;</span>
  <span class="nx">arr</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
</code></pre></div></div> <p>It does the job and it’s fairly straightforward. But there is actually a small issue, which I’ll address in later.</p> <h2 id="comparison-with-_sample">Comparison with <code class="language-plaintext highlighter-rouge">_.sample</code></h2> <p>After implementing it, I thought that there is a <code class="language-plaintext highlighter-rouge">_.sample</code> function from the popular library <a href="https://www.npmjs.com/package/lodash">lodash</a>, it would be interesting to see how it was implemented.</p> <p>I’m going to look at the latest version of lodash, which is 4.17.21 as of this writing.</p> <p>The <a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L9820-L9837"><code class="language-plaintext highlighter-rouge">_.sample</code></a> function looks like this:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Gets a random element from `collection`.
 *
 * @static
 * @memberOf _
 * @since 2.0.0
 * @category Collection
 * @param {Array|Object} collection The collection to sample.
 * @returns {*} Returns the random element.
 * @example
 *
 * _.sample([1, 2, 3, 4]);
 * // =&gt; 2
 */</span>
<span class="kd">function</span> <span class="nx">sample</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span> <span class="p">?</span> <span class="nx">arraySample</span> <span class="p">:</span> <span class="nx">baseSample</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">collection</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Apparently it handles not only arrays but also collections in general.</p> <p>I won’t worry about <code class="language-plaintext highlighter-rouge">baseSample</code> for collections that are not array in this article. But if you like, feel free to check out <a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L3986-L3995">its source</a>.</p> <p>For arrays, it delegates to a <a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L2452-L2462"><code class="language-plaintext highlighter-rouge">arraySample</code></a> function, which looks like this:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * A specialized version of `_.sample` for arrays.
 *
 * @private
 * @param {Array} array The array to sample.
 * @returns {*} Returns the random element.
 */</span>
<span class="kd">function</span> <span class="nx">arraySample</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">length</span> <span class="p">?</span> <span class="nx">array</span><span class="p">[</span><span class="nx">baseRandom</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="p">:</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>So it checks the array length, and if length is <code class="language-plaintext highlighter-rouge">0</code> it returns <code class="language-plaintext highlighter-rouge">undefined</code>. Otherwise it’s very similar to my implementation: it calls <code class="language-plaintext highlighter-rouge">baseRandom</code> with <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">length - 1</code> to (presumably) get a random integer, then use it as index for the array and gets a random element from the array.</p> <p>In order for this to work, the <a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L3910-L3921"><code class="language-plaintext highlighter-rouge">baseRandom</code></a> function must generate a random integer between its two arguments.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * The base implementation of `_.random` without support for returning
 * floating-point numbers.
 *
 * @private
 * @param {number} lower The lower bound.
 * @param {number} upper The upper bound.
 * @returns {number} Returns the random number.
 */</span>
<span class="kd">function</span> <span class="nx">baseRandom</span><span class="p">(</span><span class="nx">lower</span><span class="p">,</span> <span class="nx">upper</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">lower</span> <span class="o">+</span> <span class="nx">nativeFloor</span><span class="p">(</span><span class="nx">nativeRandom</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">upper</span> <span class="o">-</span> <span class="nx">lower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>And looks like it does!</p> <p><a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L1532"><code class="language-plaintext highlighter-rouge">nativeFloor</code></a> and <a href="https://github.com/lodash/lodash/blob/4.17.21/lodash.js#L1542"><code class="language-plaintext highlighter-rouge">nativeRandom</code></a> in here are just aliases for the built-in methods <code class="language-plaintext highlighter-rouge">Math.Floor</code> and <code class="language-plaintext highlighter-rouge">Math.random</code>.</p> <h2 id="improvement">Improvement</h2> <p>I’m glad to see that the core logic of <code class="language-plaintext highlighter-rouge">_.sample</code> for arrays is very similar to the <code class="language-plaintext highlighter-rouge">getRandomElement</code> function I got. However, it did check the array length, which I forgot to do.</p> <p>In my use case, <code class="language-plaintext highlighter-rouge">getRandomElement</code> is just used as a test helper and the same non-empty array constant is always passed in, so omitting the array length check isn’t causing any issue for now.</p> <p>But for completeness’ sake and also to allow it to be used in other scenarios in the future, I should add the array length check. So the function becomes:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">getRandomElement</span> <span class="o">=</span> <span class="p">(</span><span class="nx">arr</span><span class="p">:</span> <span class="kr">any</span><span class="p">[])</span> <span class="o">=&gt;</span>
  <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="p">?</span> <span class="nx">arr</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span> <span class="p">:</span> <span class="kc">undefined</span>
</code></pre></div></div> <h2 id="summary">Summary</h2> <p>In this article, I walked through how to implement a function for getting a random element from an array, had a tour in lodash source code around <code class="language-plaintext highlighter-rouge">_.sample</code> and improved the initial implementation by adding an array length check to make it more complete and robust.</p> <p>Open source not only come in handy when we need to use them directly in our projects, but also serve as a great resource for learning.</p> <p>I definitely should look more into source code of open source libraries and frameworks. Maybe you should too :smile:</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="Javascript"/><category term="Typescript"/><category term="mini-patterns"/><category term="array"/><category term="lodash"/><summary type="html"><![CDATA[Typescript Mini-patterns]]></summary></entry><entry><title type="html">How to Use asdf Version Manager on macOS</title><link href="https://www.wiserfirst.com/blog/how-to-use-asdf-on-macos/" rel="alternate" type="text/html" title="How to Use asdf Version Manager on macOS"/><published>2021-05-15T19:35:00+10:00</published><updated>2021-09-05T17:30:00+10:00</updated><id>https://www.wiserfirst.com/blog/how-to-use-asdf-on-macos</id><content type="html" xml:base="https://www.wiserfirst.com/blog/how-to-use-asdf-on-macos/"><![CDATA[<p>Last year, I wrote a post titled <a href="/blog/install-java-with-asdf/">Install Java with asdf</a> and slightly surprising to me, it ended up becoming the most visited article on my personal blog. Given that, I decided to write another more complete guide to asdf. Even though this guide is meant for macOS, most things covered here should apply to Linux systems too, potentially with some minor tweaks.</p> <h2 id="why-asdf">Why asdf</h2> <p>Before we begin, let’s talk about why we might need it in the first place.</p> <p>Say you work as a developer for a company and their tech stack is backend Ruby on Rails and frontend React. There are quite a number of repositories for different services and unsurprisingly not all of them use the same versions of Ruby or Node.js.</p> <p>To manage the different versions of Ruby, <a href="https://github.com/rbenv/rbenv">rbenv</a> is a good tool and for Node.js, you have <a href="https://github.com/nvm-sh/nvm">nvm</a>. Then Python is introduced for some machine learning related tasks, so here comes <a href="https://github.com/pyenv/pyenv">pyenv</a>.</p> <p>Three tools to manage versions for three programming languages doesn’t sound too bad, but they all have slightly different command syntax for you to remember and use from time to time. The situation only gets worse with more languages introduced to the mix. For example, what if you want to build a side project with Elixir/Phoenix or learn some Rust.</p> <p>One version manager for each programming language is still okay for three languages, but once the number reaches five or six, it becomes too much effort.</p> <h3 id="asdf-to-the-rescue">asdf to the rescue</h3> <p>Luckily there is asdf and you can replace <code class="language-plaintext highlighter-rouge">rbenv</code>, <code class="language-plaintext highlighter-rouge">nvm</code>, <code class="language-plaintext highlighter-rouge">pyenv</code> and more with just this one tool.</p> <p>Thanks to its plugin system, asdf is extendable enough for you to install and manage versions of almost all programming languages that you might want to use. And with asdf you only need to learn one set of simple commands to do that.</p> <p>Furthermore, if you’d like to manage something and there isn’t yet a plugin for it, it’s possible to <a href="https://asdf-vm.com/#/plugins-create">create a plugin</a> yourself.</p> <p>With a relatively small core and the powerful plugin system, asdf offers nearly infinite possibilities.</p> <h2 id="install-asdf">Install asdf</h2> <p>First make sure that <code class="language-plaintext highlighter-rouge">coreutils</code>, <code class="language-plaintext highlighter-rouge">curl</code> and <code class="language-plaintext highlighter-rouge">git</code> are installed:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>coreutils curl git
</code></pre></div></div> <h3 id="install-with-git">Install with Git</h3> <p>Personally I prefer installing asdf with Git, because it gives complete control and avoids some pitfalls.</p> <p>Cloning the latest tag is enough:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/asdf-vm/asdf.git ~/.asdf <span class="nt">--branch</span> v0.8.1
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">v0.8.1</code> is the latest tag as of September 2021, but obviously that would change over time, so make sure to check its <a href="https://github.com/asdf-vm/asdf/tags">Github repository</a> for that before you install.</p> <p>Then for Zsh add the following to the bottom of <code class="language-plaintext highlighter-rouge">~/.zshrc</code>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> <span class="nv">$HOME</span>/.asdf/asdf.sh
</code></pre></div></div> <p>Open a new terminal tab and you should be ready to use asdf :tada:</p> <h3 id="install-with-homebrew">Install with Homebrew</h3> <p>The alternative is to install asdf with Homebrew:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>asdf
</code></pre></div></div> <p>If you prefer this method, before continuing, do check out <a href="https://github.com/asdf-vm/asdf/issues/785">Common Homebrew issues</a> to be aware of potential issues you might run into.</p> <p>And add the following line to the bottom of your <code class="language-plaintext highlighter-rouge">~/.zshrc</code>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> <span class="si">$(</span>brew <span class="nt">--prefix</span> asdf<span class="si">)</span>/asdf.sh
</code></pre></div></div> <blockquote> <p>If you use Bash or Fish shell, please refer to the <a href="https://asdf-vm.com/#/core-manage-asdf?id=add-to-your-shell">Add to your Shell</a> section in asdf documentation for instructions.</p> </blockquote> <h2 id="manage-plugins">Manage Plugins</h2> <p>Before you could install Ruby, Node.js or anything else, you’ll need to add the appropriate plugins. Plugins are how asdf understands handling of different programming languages or, say, packages.</p> <p>There is an <a href="https://asdf-vm.com/#/plugins-all">asdf plugins repository</a> and for all the plugins listed there, you can add with just the plugin name. For example, here is how to add the plugins for Ruby and Node.js:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin add ruby
asdf plugin add nodejs
</code></pre></div></div> <p>If the plugin you want is not part of this repository, you can still add it with its repository URL. For example:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin-add elm https://github.com/vic/asdf-elm
</code></pre></div></div> <p>You can list installed plugins with:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin list
</code></pre></div></div> <p>Or list all available plugins from the asdf plugin repository:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf plugin list-all
</code></pre></div></div> <h2 id="manage-language-versions">Manage Language Versions</h2> <p>If you’ve looked through the asdf plugin repository, you may have noticed that there are plugins not only for programming languages, but also for many other cli tools like <code class="language-plaintext highlighter-rouge">fzf</code>, <code class="language-plaintext highlighter-rouge">minikube</code> etc.</p> <p>For the purpose of our discussion here, whether it’s a programming language or something else doesn’t really matter, because the commands for managing them are going to be the same. I’ll just refer to them as programming languages in this post, but please keep in mind that you could use asdf to manage other cli tools as well.</p> <h3 id="install-versions">Install Versions</h3> <p>Suppose we want to install the latest stable release of Ruby 2 and the latest LTS release of Node.js, which are <code class="language-plaintext highlighter-rouge">2.7.2</code> and <code class="language-plaintext highlighter-rouge">14.16.1</code> respectively as of this writing. We can simply run the following:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf <span class="nb">install </span>ruby 2.7.2
asdf <span class="nb">install </span>nodejs 14.16.1
</code></pre></div></div> <blockquote> <p>When you run into issues trying to install a particular language version, make sure to check out the Github repository for the plugin. It’s very likely that you’ll find instructions on how to solve those issues.</p> </blockquote> <h3 id="set-global-versions">Set Global Versions</h3> <p>After installing the first versions, you might also want to set them as global versions for Ruby and Node.js:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf global ruby 2.7.2
asdf global nodejs 14.16.1
</code></pre></div></div> <p>With this, we’ve made Ruby <code class="language-plaintext highlighter-rouge">2.7.2</code> and Node.js <code class="language-plaintext highlighter-rouge">14.16.1</code> “globally” available for the current user.</p> <p>In asdf terms, “global” means default everywhere. So unless it’s overridden with either a local or shell version, which are covered in the following sections, asdf will assume the global version is the one to use.</p> <h3 id="set-local-versions-optional">Set Local Versions (Optional)</h3> <p>Suppose we have a legacy project that we need to maintain and it only runs on Node.js 10. What we can do with asdf is to install Node.js 10 and set a local version in the project directory:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf <span class="nb">install </span>nodejs 10.22.0
<span class="c"># run in the project directory</span>
asdf <span class="nb">local </span>nodejs 10.22.0
</code></pre></div></div> <p>With this local version set, when you are in the legacy project directory or its subdirectories, asdf will automatically switch to Node.js version <code class="language-plaintext highlighter-rouge">10.22</code>; when you are in any other directories, it’ll fallback to the global Node.js version, unless of course if there is another local Node.js version set.</p> <h3 id="set-shell-version-optional">Set Shell Version (Optional)</h3> <p>I had a fairly interesting situation at work recently. On this project, the backend server and frontend client each lives in a subdirectory in the same repository and we are in the process of developing a new client app to replace the old one.</p> <p>Normally I just run the server and new client, both of which run on Node.js 14. This time I needed to run the old client to confirm some behaviours on a page, but it requires Node.js 10.</p> <p>In order to run the old client together with the server, I made another copy of the whole project, set a local Node.js version to <code class="language-plaintext highlighter-rouge">10.22.0</code> in the new directory and run the old client. For the server, since the local Node.js version is already set to <code class="language-plaintext highlighter-rouge">14.16.1</code> in the original project directory, I could still start it in as normal.</p> <p>That certainly worked fine for me. But later I learned that there is a much simpler way: to use an asdf shell version. Without making an extra copy of the project, I could simply start a new shell session in the project directory and set a shell version for Node.js by:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>path/to/project
asdf shell nodejs 10.22.0
<span class="c"># run old client</span>
</code></pre></div></div> <p>This shell version only affects the current shell session, nothing else.</p> <p>As for the server, just run it in another shell session would do.</p> <h3 id="quick-recap">Quick Recap</h3> <p>So basically asdf allows you to select different versions of programming languages on a per directory basis, and on top of that you have the option to set a shell version which only affects the current shell session.</p> <p>I think that should be flexible enough for anyone to cope with most of (if not all) the situations they’ll ever encounter.</p> <h2 id="under-the-hood">Under the Hood</h2> <div style="margin: auto; text-align: center; width: 100%;"> <figure style="display: block"> <img src="/assets/images/2021-05-15/underhood_1024_540.jpg" alt="Mustang car with open hood"/> <figcaption style="text-align: center;"> Blue Mustang Coupe with Hood Open by <a href="https://unsplash.com/@aliivan">Alison Ivansek</a> from <a href="https://unsplash.com/photos/HAI-GVIEvSQ">Unsplash</a> </figcaption> </figure> </div> <p>To someone who’s new that might sound like magic, but in fact how asdf works is actually quite straightforward.</p> <h3 id="global-versions">Global Versions</h3> <p>When you set a global version for a programming language, it’ll add or update a line for the language in a <code class="language-plaintext highlighter-rouge">.tool-versions</code> file under the current user’s home directory. If the file doesn’t already exist, it’ll create it first and then add the new line.</p> <p>If you’ve followed this post to install asdf, install Ruby and Node.js, and then set the global versions, your <code class="language-plaintext highlighter-rouge">.tool-versions</code> file in home directory should look like the following:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cat ~/.tool-versions</span>
nodejs 14.16.1
ruby 2.7.2
</code></pre></div></div> <h3 id="local-versions">Local Versions</h3> <p>When you set a local version in a directory, asdf will add or update a line for the language in a <code class="language-plaintext highlighter-rouge">.tool-versions</code> file under that directory. Same as the global <code class="language-plaintext highlighter-rouge">.tool-versions</code> file, it’ll be created if not exist already.</p> <p>Say you do have that legacy project where Node.js <code class="language-plaintext highlighter-rouge">10.22</code> is required and therefore you’ve set a local version for Node.js in the project directory. The <code class="language-plaintext highlighter-rouge">.tool-versions</code> file under the project directory should look like this:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd path/to/project</span>
<span class="c"># cat ~/.tool-versions</span>
nodejs 10.22.0
</code></pre></div></div> <p>If you’re working on a personal project or your team has adopted asdf, it would be a very good idea to commit the <code class="language-plaintext highlighter-rouge">.tool-version</code> file to Git or the version control system you use.</p> <p>On the other hand, if your team hasn’t reached an agreement on adopting asdf, I’d recommend adding it to <code class="language-plaintext highlighter-rouge">.gitignore</code> and keeping it locally without committing to version control. The <a href="/blog/how-to-use-asdf-on-macos/#migrate-from-legacy-tools">Migrate from Legacy Tools</a> section might offer more useful information, if you found yourself in situations like this.</p> <h3 id="shell-versions">Shell Versions</h3> <p>How shell versions work is even simpler in my opinion. When you set one, asdf will set an environment variable <code class="language-plaintext highlighter-rouge">ASDF_${LANG}_VERSION</code> for the current session.</p> <p>For example, when I set a shell version for Node.js to <code class="language-plaintext highlighter-rouge">10.22.0</code>, asdf creates an environment variable named <code class="language-plaintext highlighter-rouge">ASDF_NODEJS_VERSION</code> with value <code class="language-plaintext highlighter-rouge">10.22.0</code> in my shell session.</p> <p>Given that’s how it works, setting the environment variable for a particular language directly in a shell session or even for just one command would work too.</p> <p>The following example starts the Rails server with Ruby version <code class="language-plaintext highlighter-rouge">2.5.3</code>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ASDF_RUBY_VERSION</span><span class="o">=</span>2.5.3 bundle <span class="nb">exec </span>rails server
</code></pre></div></div> <h3 id="current-versions">Current Versions</h3> <p>When you run <code class="language-plaintext highlighter-rouge">node</code> for example, asdf will look for a <code class="language-plaintext highlighter-rouge">.tool-versions</code> file in the current directory, then the parent directory, then parent’s parent directory etc. If it does find one and a local Node.js version is specified, it’ll use that version. In the case it couldn’t find one, it’ll fallback to the global version set in the <code class="language-plaintext highlighter-rouge">.tool-versions</code> file under the current user’s home directory. So the logic is quite straightforward.</p> <p>You could run <code class="language-plaintext highlighter-rouge">asdf current</code> to get a list of current versions of installed programming languages in the current directory. For example, say we are in the legacy project directory, where a local Node.js version is set, but no Ruby version is set. What you get should be something like this:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># asdf current</span>
nodejs          10.22.0         /Users/username/workspace/legacy-project/.tool-versions
ruby            2.7.2           /Users/username/.tool-versions
</code></pre></div></div> <p>Whereas if you run it in another directory, assuming no local versions are set, what you get is slightly different:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># asdf current</span>
nodejs          14.16.1         /Users/username/.tool-versions
ruby            2.7.2           /Users/username/.tool-versions
</code></pre></div></div> <p>As you can see, in the output, it not only tells you what the current versions are, but also shows from which <code class="language-plaintext highlighter-rouge">.tool-versions</code> file asdf got each version.</p> <p>I reckon this command could come in handy when you try to figure out where a particular local version is set.</p> <h2 id="use-asdf-in-a-team">Use asdf in a Team</h2> <p>Coming back to the scenario mentioned at the beginning of this article, where you work for a company which uses Ruby on Rails for backend and React for frontend and different projects might have different language version requirements.</p> <p>After introducing asdf you no longer have to deal with different tools for managing versions of different programming languages, which is great. But obviously when starting to work on a different project for the first time, everyone still need to get the correct local versions installed.</p> <p>What I used to do is to check out what are the versions specified in the <code class="language-plaintext highlighter-rouge">.tool-versions</code> file of the project and then manually install them. For example, if the file has</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nodejs 10.22.0
ruby 2.5.3
</code></pre></div></div> <p>Running the following should do it:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asdf <span class="nb">install </span>nodejs 10.22.0
asdf <span class="nb">install </span>ruby 2.5.3
</code></pre></div></div> <p>But this feels slightly tedious and it is.</p> <p>Luckily as it turns out there is a much better way: running <code class="language-plaintext highlighter-rouge">asdf install</code> without any arguments. If a required version is not installed yet, asdf will go ahead and install it; if a version is already installed, it will tell you that and does nothing.</p> <p>I think this is a rather neat trick for installing the specified local versions for a project, therefore it makes this aspect of onboarding new team members to a project pretty much painless.</p> <h2 id="migrate-from-legacy-tools">Migrate from Legacy Tools</h2> <p>If you are sold on asdf but for whatever reason can’t adopt it at work, there is a configuration option that could allow you to still use it.</p> <p>What you need to do is to create a <code class="language-plaintext highlighter-rouge">.asdfrc</code> file in your home directory with the following content:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>legacy_version_file <span class="o">=</span> <span class="nb">yes</span>
</code></pre></div></div> <p>Setting this to <code class="language-plaintext highlighter-rouge">yes</code> will cause asdf plugins to read “legacy” version files, for example <code class="language-plaintext highlighter-rouge">.ruby-versions</code> for Ruby and <code class="language-plaintext highlighter-rouge">.nvmrc</code> or <code class="language-plaintext highlighter-rouge">.node-versions</code> for Node.js.</p> <p>This is especially helpful when you are in a team where your teammates don’t want to change to a different tool for managing the programming languages. Change is hard even when there are obviously benefits, so expect resistance if people are not already familiar with asdf.</p> <p>With this setting though, they can continue to use the legacy tools they prefer, but you would have the option to use asdf if you want.</p> <blockquote> <p>Note: not all plugins support this feature. If you rely on this behaviour, please do check the documentation of the plugins you use.</p> </blockquote> <p>Hopefully one day they’ll start noticing conveniences of asdf and change their minds, at which point the whole team could fully adopt asdf and enjoy the benefits it brings.</p> <h2 id="summary">Summary</h2> <p>In this post, I covered:</p> <ul> <li>how to install asdf</li> <li>how to add plugins</li> <li>how to manage versions</li> <li>how versions work under the hood</li> <li>how asdf fits in a team setting</li> <li>how to use asdf with legacy tools</li> </ul> <p>While there are definitely aspects of asdf that I didn’t cover, this should be a solid starting point for someone new. After reading this post and following along, you should be able to start using asdf with confidence. If you do run into issues, check out <a href="https://asdf-vm.com/#/core-manage-asdf">asdf documentation</a> and Google is your friend.</p> <p>With asdf, one could manage different versions of all the programming languages that they might need without any trouble, and also it makes sharing a common set of programming language versions across a team for a project very easy.</p> <p>Because of the conveniences it offers, I’m a big fan of asdf and I truly believe that every developer should use it or at least know it as a potential option to consider.</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="asdf"/><category term="version-manager"/><category term="macos"/><category term="ruby"/><category term="nodejs"/><category term="python"/><summary type="html"><![CDATA[Discover a fantastic version manager for programming languages]]></summary></entry><entry><title type="html">Converting mov/avi to mp4 with ffmpeg</title><link href="https://www.wiserfirst.com/blog/converting-mov-to-mp4-ffmpeg/" rel="alternate" type="text/html" title="Converting mov/avi to mp4 with ffmpeg"/><published>2021-04-02T12:50:00+11:00</published><updated>2021-05-16T17:40:00+10:00</updated><id>https://www.wiserfirst.com/blog/converting-mov-to-mp4-ffmpeg</id><content type="html" xml:base="https://www.wiserfirst.com/blog/converting-mov-to-mp4-ffmpeg/"><![CDATA[<p>Since I have a camera that captures video in Quicktime movie format, I end up with a lot of .mov videos. While it’s a reasonable format, it does have a big drawback: the video files are really big and therefore my SSD is running out of space.</p> <p>In order to save some space, I’d like to convert the .mov files to .mp4.</p> <p>There are various online tools that I can use for the conversion, but uploading the original videos and downloading the resulting videos would take a long time, especially considering I have multiple videos that are several Gigabytes. So the online tools aren’t right for me.</p> <p>Luckily there is a neat cli tool named <a href="https://www.ffmpeg.org/">ffmpeg</a> that can do the trick. If you don’t already have it, you can install (on macOS) by</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew <span class="nb">install </span>ffmpeg
</code></pre></div></div> <p>Or if you are on Linux, most likely you can install it with your package manager; if not, go to its <a href="https://www.ffmpeg.org/download.html">download page</a> to find the appropriate installer.</p> <p>To convert a .mov file to .mp4, you can run</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg <span class="nt">-i</span> input-video-name.mov <span class="nt">-vcodec</span> h264 output-video-name.mp4
</code></pre></div></div> <p>For more details, please refer to the <a href="https://www.ffmpeg.org/ffmpeg.html">ffmpeg documentation</a>.</p> <p>This is good enough if there are only a handful of videos to convert, but it can become tedious to run the command manually for say 20 videos. So I created a quick and dirty Ruby script for converting all the .mov or .avi videos in a directory. And yes, thanks to ffmpeg, the same command can work with .avi videos as well.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="k">def</span> <span class="nf">usage</span>
  <span class="nb">puts</span> <span class="o">&lt;&lt;~</span><span class="no">HEREDOC</span><span class="sh">
    Usage:
    ./video-converter.rb [dir]
    to convert mov/avi files to mp4 with H.264 video codec and AAC audio codec"
</span><span class="no">  HEREDOC</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="n">usage</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="n">dir</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="s1">'.'</span>

<span class="k">unless</span> <span class="no">Dir</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\e</span><span class="s2">[31mDirectory </span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2"> not found</span><span class="se">\e</span><span class="s2">[0m"</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="no">Dir</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
<span class="no">Dir</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="s1">'*.{avi,mov}'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
  <span class="n">basename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n\e</span><span class="s2">[32mConverting </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">basename</span><span class="si">}</span><span class="s2">.mp4</span><span class="se">\e</span><span class="s2">[0m"</span>
  <span class="nb">system</span><span class="p">(</span><span class="s2">"ffmpeg -i </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> -vcodec h264 </span><span class="si">#{</span><span class="n">basename</span><span class="si">}</span><span class="s2">.mp4"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div> <p>I understand there are various ways to improve this script to make it more flexible/robust, but for now this is good enough for my purpose and hopefully it is useful for someone else too.</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="ffmpeg"/><category term="mov"/><category term="avi"/><category term="mp4"/><summary type="html"><![CDATA[Explore a great cli tool for converting between video formats]]></summary></entry><entry><title type="html">Vim Tip: Fix Legacy Parser Warning for snipMate</title><link href="https://www.wiserfirst.com/blog/vim-tip-snipmate-legacy-parser-warning/" rel="alternate" type="text/html" title="Vim Tip: Fix Legacy Parser Warning for snipMate"/><published>2021-03-13T10:40:00+11:00</published><updated>2021-05-16T17:35:00+10:00</updated><id>https://www.wiserfirst.com/blog/vim-tip-snipmate-legacy-parser-warning</id><content type="html" xml:base="https://www.wiserfirst.com/blog/vim-tip-snipmate-legacy-parser-warning/"><![CDATA[<p>If you use both Vim and snipMate, and upgraded snipMate to the latest version recently, you might encounter a warning:</p> <blockquote> <p>The legacy SnipMate parser is deprecated. Please see :h SnipMate-deprecate</p> </blockquote> <p>If you follow the instruction and run <code class="language-plaintext highlighter-rouge">:h SnipMate-deprecate</code>, you’ll see the following in a help window:</p> <blockquote> <p>The legacy parser, version 0, is deprecated. It is currently still the default parser, but that will be changing. NOTE that switching which parser you use could require changes to your snippets–see the previous section.</p> <p>To continue using the old parser, set g:snipMate.snippet_version (see |SnipMate-options|) to 0 in your |vimrc|.</p> <p>Setting g:snipMate.snippet_version to either 0 or 1 will remove the start up message. One way this can be done–to use the new parser–is as follows:</p> <p>let g:snipMate = { ‘snippet_version’ : 1 }</p> </blockquote> <p>Basically there is a new parser in snipMate, but the deprecated legacy parser is still the default, which would cause this warning. Explicitly setting the parser version to either 0 for the old parser or 1 for the new parser would remove this start up warning message.</p> <p>There doesn’t seem to be a reason not to use the new parser, so I just added the following in my <code class="language-plaintext highlighter-rouge">.vimrc</code>:</p> <div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">let</span> <span class="nv">g:snipMate</span> <span class="p">=</span> <span class="p">{</span> <span class="s1">'snippet_version'</span> <span class="p">:</span> <span class="m">1</span> <span class="p">}</span>
</code></pre></div></div> <p>Now the annoying warning upon starting Vim is gone :tada:</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="tiny-tips"/><category term="vim"/><summary type="html"><![CDATA[A quick tip for resolving a warning message from snipMate]]></summary></entry><entry><title type="html">Git Tip: Prune Stale Remote References</title><link href="https://www.wiserfirst.com/blog/git-tip-prune-stale-remote-references/" rel="alternate" type="text/html" title="Git Tip: Prune Stale Remote References"/><published>2020-10-31T19:20:00+11:00</published><updated>2021-05-16T18:15:00+10:00</updated><id>https://www.wiserfirst.com/blog/git-tip-prune-stale-remote-references</id><content type="html" xml:base="https://www.wiserfirst.com/blog/git-tip-prune-stale-remote-references/"><![CDATA[<p>When a colleague pushes a new branch to Github, we can run the following to get it locally:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git pull <span class="c"># or git fetch</span>
git checkout &lt;branch-name&gt;
</code></pre></div></div> <p>This works because git uses what’s called “remote references” to keep track of the last known state of remote branches, which are essentially read-only bookmarks. In this case, <code class="language-plaintext highlighter-rouge">git pull</code> would create a new remote reference for the new remote branch apart from updating existing remote references. Then <code class="language-plaintext highlighter-rouge">git checkout ...</code> would create a new local branch that tracks the new remote branch and switch to it.</p> <p>That’s all well and good until there are too many branches in the codebase, which is not at all uncommon when working in a reasonably sized team. Git automatically creates remote references for all known remote branches, but it doesn’t automatically remove stale remote references when the remote branches are deleted. This annoys me because the stale remote references might mess with my auto-completion for branch names. After some Googling, I managed to find a way to remove them for the default remote connection <code class="language-plaintext highlighter-rouge">origin</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote prune origin
</code></pre></div></div> <p>Also the following command lists remote references:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git remote show origin
</code></pre></div></div> <p>After sharing my findings with my colleagues, they pointed out that passing the <code class="language-plaintext highlighter-rouge">--prune</code> option to <code class="language-plaintext highlighter-rouge">git pull</code> or <code class="language-plaintext highlighter-rouge">git fetch</code> would do the trick as well. As mentioned in this nice <a href="https://www.atlassian.com/git/tutorials/git-prune">tutorial for git prune</a>, the following:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git fetch <span class="nt">--prune</span>
</code></pre></div></div> <p>is the same as:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git fetch <span class="nt">--all</span> <span class="o">&amp;&amp;</span> git remote prune
</code></pre></div></div>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="tiny-tips"/><category term="git"/><summary type="html"><![CDATA[A Git tip that I didn't know before and I find it very useful at times]]></summary></entry><entry><title type="html">Migrating Blog to Jekyll</title><link href="https://www.wiserfirst.com/blog/migrating-blog-to-jekyll/" rel="alternate" type="text/html" title="Migrating Blog to Jekyll"/><published>2020-10-26T16:31:00+11:00</published><updated>2021-05-16T18:22:00+10:00</updated><id>https://www.wiserfirst.com/blog/migrating-blog-to-jekyll</id><content type="html" xml:base="https://www.wiserfirst.com/blog/migrating-blog-to-jekyll/"><![CDATA[<p>Back in 2010, I started blogging on <a href="https://wordpress.com/">WordPress</a>. The reason was simple, I thought since it is the world’s most popular blogging system, it should offer reasonably good user experience. But to my surprise, The UI wasn’t that great especially for technical posts with code snippets. Having done no web development at all back then, I just had to cope with it.</p> <p>Fast forward to 2012, I started doing web development with ASP.NET/C#. My former colleagues <a href="https://twitter.com/jun_cn">Yijun Xu</a> and <a href="https://twitter.com/aqi678">Jianguo Ning</a> at the time were creating their blog sites with <a href="https://jekyllrb.com/">Jekyll</a> + <a href="https://github.com/octopress/octopress">Octopress</a> and hosted on <a href="https://pages.github.com/">Github Pages</a> under custom domains. So with their help, I managed to do the same. I really liked the result, because for me writing markdown felt more in control than fiddling with WordPress’ WYSIWYG interface. My old Jekyll blog was using a theme named <a href="https://github.com/muan/scribble">Scribble</a>. I liked the fact that it was a fairly minimalist theme, but there were things I had hoped to be different. For example, when viewed on a modern computer, the viewing area was too narrow. While syntax highlighting for code snippets was possible, the color schema wasn’t the best. Having said all that though, it was probably the best I could have done. I was still new as a web developer by then and my frontend skills are fairly limited, so designing or customising a Jekyll theme was too far-fetched for me.</p> <p>After not blogging for the whole 2016, I started writing super short posts on <a href="https://medium.com/@wiserfirst">Medium</a> in early 2017, because those are more approachable than longer form articles. I was quite impressed by Medium’s editing interface, which is a fine balance between markdown and WYSIWYG and the published articles look gorgeous as well. So I was happy with Medium for a few years, until they started to enforce what they call a “<a href="https://help.medium.com/hc/en-us/articles/360017581433-About-the-metered-paywall">metered paywall</a>”. Of course there was a rational behind the <a href="https://blog.medium.com/the-medium-model-3ec28c6f603a">Medium Model</a> and to be honest, that was a nice idea, but still I wasn’t a fan. I write to share what I’ve learnt and I want my writings freely available for everyone who’s interested. So naturally any form of paywalls are at odds with my purpose for writings.</p> <p>A few months ago, I finally decided 2020 is the year to stop putting up with the platform with a paywall and to migrate my personal blog back to Jekyll. Apparently Jekyll has improved massively over the past eight years in terms of user experience. Kudos to the <a href="https://jekyllrb.com/team/">Jekyll team</a> :+1:! Also I received lots of help from <a href="https://twitter.com/paulfioravanti">Paul</a> and the <a href="https://github.com/paulfioravanti/paulfioravanti.github.io">source for his blog</a> at <a href="https://www.paulfioravanti.com">paulfioravanti.com</a> was a great resource to learn from. I ended up picking the same theme <a href="https://mmistakes.github.io/minimal-mistakes/">Minimal Mistakes</a>, but chose the dark skin because I like dark mode for everything. Since I got help again, setting up the blog itself was a pleasant task.</p> <h2 id="content-migration">Content Migration</h2> <p>Because of the phases of my blogging journey, I have content in three different forms, which means I’ll need to migrate them in different ways too.</p> <h3 id="wordpress">WordPress</h3> <p>Posts in WordPress can be exported in XML format and then there is a node tool called <a href="https://github.com/lonekorean/wordpress-export-to-markdown">wordpress-export-to-markdown</a> that can help convert them into markdown.</p> <p>First login to the WordPress admin console and navigate to the “Export Content” page via Tools -&gt; Export . Then hitting the “Export all” button should get all the posts in WordPress exported in a single XML file.</p> <p>Next run <code class="language-plaintext highlighter-rouge">wordpress-export-to-markdown</code> with npx to convert the posts from XML into markdown:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx wordpress-export-to-markdown <span class="nt">--input</span><span class="o">=</span>path-to-your-export-file.xml
</code></pre></div></div> <p>Or another option is to clone the repository and run it locally, which makes repeated runs much faster:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:lonekorean/wordpress-export-to-markdown.git
<span class="nb">cd </span>wordpress-export-to-markdown
npm <span class="nb">install
</span>node index.js
</code></pre></div></div> <p>The nice thing about this tool is by default it starts in wizard mode and asks about any options not provided on the command line. To learn more about available options, head over to <a href="https://github.com/lonekorean/wordpress-export-to-markdown">its Github repository</a>. Also <a href="https://kevq.uk/how-to-convert-wordpress-to-markdown/">How To Convert WordPress To Markdown</a> by Kev Quirk covers converting WordPress to markdown in great details. You might want to check it out.</p> <h3 id="jekyll">Jekyll</h3> <p>For posts from my old Jekyll blog, it should have been straightforward because they were originally written in markdown already. But regrettably for some reason I only put the generated site in the blog repository on Github without the markdown files, so the HTML files were what I had to work with. That was definitely more work than if I could just copy over the original markdown files, but I found an online tool called <a href="https://mixmark-io.github.io/turndown/">Turndown</a> to convert HTML to Markdown, which made working on this much more tolerable. It also offer options to choose heading style, code block style and etc., which I found quite handy.</p> <p>For each of my old Jekyll posts, I had to paste in the HTML source and copy the markdown output into a new file. That was quite repetitive for sure, but since there was only less than ten posts in this category, it wasn’t too bad. This time around, I wouldn’t make the same mistake. The source of my blog is in <a href="https://github.com/wiserfirst/wiserfirst.github.io">this repository</a>. Hopefully open-soucing the blog itself would make the life of future me a bit easier and might even help others too.</p> <h3 id="medium">Medium</h3> <p>Lastly it comes to migrating my posts in Medium and for that there is an npm package named <code class="language-plaintext highlighter-rouge">mediumexporter</code>. First install it with</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">-g</span> mediumexporter
</code></pre></div></div> <p>Then run it with</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mediumexporter https://url-to-the-medium-post-to-export <span class="o">&gt;</span> exported_post.md
</code></pre></div></div> <p>Similar to Turndown, I had to go through all my Medium posts one by one with <code class="language-plaintext highlighter-rouge">mediumexporter</code>. Again there was less than ten, so it was okay.</p> <p>If you’d like more details about exporting Medium posts to markdown, check out <a href="https://medium.com/@macropus/export-your-medium-posts-to-markdown-b5ccc8cb0050">Export your Medium posts to Markdown</a>.</p> <h2 id="content-adjustment">Content Adjustment</h2> <p>After getting the content as markdown from the three sources, I still need to make various adjustments.</p> <h3 id="front-matter">Front Matter</h3> <p>Most posts exported from the above tools do not include Jekyll front matter and even when front matter is included, it doesn’t have the relevant tags. So I’d like to add front matter with title, date and tags to all posts, which would look like the following:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">title</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Understanding</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">Use</span><span class="nv"> </span><span class="s">Statement</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">Elixir</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Examples"</span>
<span class="na">date</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2015-10-14"</span>
<span class="na">tags</span><span class="pi">:</span> <span class="s">elixir use</span>
<span class="nn">---</span>
</code></pre></div></div> <h3 id="style-consistency">Style Consistency</h3> <p>As mentioned earlier, Turndown supports choosing markdown styles for heading, code block, etc., which is handy. But unfortunately, the other two export tools doesn’t provide such options, therefore I had to make manual adjustments in order to keep the style consistent.</p> <p>For example, <code class="language-plaintext highlighter-rouge">mediumexporter</code> uses indentation for code blocks:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    asdf plugin-add java
</code></pre></div></div> <p>But I prefer fenced with back ticks:</p> <div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">```</span><span class="nl">bash
</span>asdf plugin-add java
<span class="p">```</span>
</code></pre></div></div> <h3 id="updating-stale-links">Updating Stale Links</h3> <p>I have been blogging on and off for ten years, which is a long time. Unfortunately during that time many of the sites that I originally linked to are no longer live, so there are a fair number of stale links in my posts. For some of the linked pages, the site was moved and I was able to find their new home then update to the new links. For others the site was simply gone, but I still kept the stale links as plain text maybe just to note that there used to be this article on the Internet.</p> <p>Also even for the valid links, after all these years the content might be out-of-date or even irrelevant. Sadly there is not much I could do about that. Like it or not, nothing lasts for ever in this world.</p> <h2 id="summary">Summary</h2> <p>In this post, I briefly went through my blogging journey over the past ten years, noted down how I migrated content from three different sources to the current Jekyll blog and the various adjustments that were made.</p> <p>Hopefully this would serve as a reference for people who want to do the same and might even be helpful for my future self as well.</p> <p>Again I’d like to thank Paul, Yijun and Jianguo for their generous help, thank the authors to the articles I referenced for sharing their knowledge for free and thank the creators and contributors of the open source tools I used for their great work.</p>]]></content><author><name>Qing Wu</name><email>wiserfirst@gmail.com</email><uri>https://www.wiserfirst.com</uri></author><category term="jekyll"/><category term="blog"/><summary type="html"><![CDATA[Phases of my ten-year blogging journey and how it landed back on Jekyll]]></summary></entry></feed>